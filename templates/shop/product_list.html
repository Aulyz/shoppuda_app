{% extends 'shop/base.html' %}
{% load humanize %}
{% block title %}상품 목록 - {{ site_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- 페이지 헤더 -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-4">상품 목록</h1>
        
        <!-- 검색바 -->
        <form method="get" class="mb-6">
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="text" 
                       name="q" 
                       value="{{ search_query|default:'' }}"
                       placeholder="상품명으로 검색..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-search mr-2"></i>검색
                </button>
            </div>
        </form>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- 사이드바 - 카테고리 필터 -->
        <aside class="lg:w-64 relative z-40">
            <div class="bg-white rounded-lg shadow-md p-6 sticky top-20">
                <h2 class="text-lg font-semibold mb-4">카테고리</h2>
                
                <div>
                    <ul class="space-y-1 relative">
                        <li>
                            <a href="{% url 'shop:product_list' %}" 
                               class="block px-3 py-2 rounded-md hover:bg-gray-100 transition {% if not current_category %}bg-blue-50 text-blue-600 font-semibold{% endif %}">
                                <i class="fas fa-th-large mr-2"></i>전체 상품
                            </a>
                        </li>
                        
                        <!-- 카테고리 트리 렌더링 -->
                        {% for item in category_tree %}
                            <li class="category-item relative group z-50">
                                <a href="?category={{ item.category.id }}{% if search_query %}&q={{ search_query }}{% endif %}" 
                                   class="block px-3 py-2 rounded-md hover:bg-gray-100 transition flex items-center justify-between
                                          {% if current_category == item.category.id|stringformat:'s' %}bg-blue-50 text-blue-600 font-semibold{% endif %}">
                                    <span class="flex items-center">
                                        {% if item.children %}
                                            <i class="fas fa-folder mr-2 text-sm"></i>
                                        {% else %}
                                            <i class="fas fa-tag mr-2 text-sm"></i>
                                        {% endif %}
                                        {{ item.category.name }}
                                    </span>
                                    <span class="flex items-center gap-2">
                                        {% if item.category.product_set.count > 0 or item.children %}
                                            <span class="text-xs text-gray-500">
                                                ({{ item.category.product_set.count }}{% if item.children %}+{% endif %})
                                            </span>
                                        {% endif %}
                                        {% if item.children %}
                                            <i class="fas fa-chevron-right text-xs text-gray-400"></i>
                                        {% endif %}
                                    </span>
                                </a>
                                
                                <!-- 하위 카테고리 - 호버시 표시 -->
                                {% if item.children %}
                                    <ul class="absolute left-full top-0 ml-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-2 z-[100]
                                               invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-all duration-200">
                                        {% for child in item.children %}
                                            <li>
                                                <a href="?category={{ child.category.id }}{% if search_query %}&q={{ search_query }}{% endif %}" 
                                                   class="block px-3 py-2 text-sm rounded-md hover:bg-gray-100 transition flex items-center justify-between
                                                          {% if current_category == child.category.id|stringformat:'s' %}bg-blue-50 text-blue-600 font-semibold{% endif %}">
                                                    <span class="flex items-center">
                                                        <i class="fas fa-chevron-right mr-2 text-xs"></i>
                                                        {{ child.category.name }}
                                                    </span>
                                                    {% if child.category.product_set.count > 0 %}
                                                        <span class="text-xs text-gray-500">({{ child.category.product_set.count }})</span>
                                                    {% endif %}
                                                </a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- 선택된 카테고리 정보 -->
                {% if selected_category %}
                    <div class="mt-4 p-3 bg-blue-50 rounded-md">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            "{{ selected_category.name }}" 카테고리
                            {% if selected_category.parent %}
                                <span class="block text-xs mt-1">
                                    상위: {{ selected_category.parent.name }}
                                </span>
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </aside>

        <!-- 메인 컨텐츠 -->
        <div class="flex-1">
            <!-- 정렬 옵션 -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <p class="text-gray-600">
                    총 <span class="font-semibold">{{ products.count }}</span>개의 상품
                </p>
                
                <form method="get" class="flex items-center gap-2">
                    {% if current_category %}
                        <input type="hidden" name="category" value="{{ current_category }}">
                    {% endif %}
                    {% if search_query %}
                        <input type="hidden" name="q" value="{{ search_query }}">
                    {% endif %}
                    
                    <label for="sort" class="text-sm text-gray-600">정렬:</label>
                    <select name="sort" id="sort" onchange="this.form.submit()" 
                            class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="-created_at" {% if request.GET.sort == '-created_at' or not request.GET.sort %}selected{% endif %}>최신순</option>
                        <option value="selling_price" {% if request.GET.sort == 'selling_price' %}selected{% endif %}>낮은 가격순</option>
                        <option value="-selling_price" {% if request.GET.sort == '-selling_price' %}selected{% endif %}>높은 가격순</option>
                        <option value="name" {% if request.GET.sort == 'name' %}selected{% endif %}>이름순</option>
                    </select>
                </form>
            </div>

            <!-- 상품 그리드 -->
            {% if products %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {% for product in products %}
                        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition-shadow duration-300">
                            <a href="{% url 'shop:product_detail' product.id %}" class="block">
                                <!-- 상품 이미지 -->
                                <div class="relative h-48 sm:h-56 bg-gray-200">
                                    {% with primary_image=product.images.first %}
                                        {% if primary_image %}
                                            <img src="{{ primary_image.image.url }}" 
                                                 alt="{{ product.name }}" 
                                                 class="w-full h-full object-cover">
                                        {% else %}
                                            <div class="flex items-center justify-center h-full">
                                                <i class="fas fa-image text-4xl text-gray-400"></i>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                    
                                    <!-- 할인 배지 -->
                                    {% if product.discount_price %}
                                        <span class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded">
                                            {{ product.discount_percentage }}% OFF
                                        </span>
                                    {% endif %}
                                    
                                    <!-- 재고 부족 표시 -->
                                    {% if product.stock_quantity <= 5 and product.stock_quantity > 0 %}
                                        <span class="absolute top-2 left-2 bg-orange-500 text-white text-xs px-2 py-1 rounded">
                                            재고 {{ product.stock_quantity }}개
                                        </span>
                                    {% elif product.stock_quantity == 0 %}
                                        <span class="absolute top-2 left-2 bg-gray-500 text-white text-xs px-2 py-1 rounded">
                                            품절
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <!-- 상품 정보 -->
                                <div class="p-4">
                                    <!-- 브랜드 -->
                                    {% if product.brand %}
                                        <p class="text-xs text-gray-500 mb-1">{{ product.brand.name }}</p>
                                    {% endif %}
                                    
                                    <!-- 상품명 -->
                                    <h3 class="font-semibold text-gray-800 mb-2 line-clamp-2 min-h-[3rem]">
                                        {{ product.name }}
                                    </h3>
                                    
                                    <!-- 가격 정보 -->
                                    <div class="mt-auto">
                                        {% if product.discount_price %}
                                            <p class="text-xl font-bold text-blue-600">
                                                ₩{{ product.discount_price|floatformat:0|intcomma }}
                                            </p>
                                            <p class="text-sm text-gray-500 line-through">
                                                ₩{{ product.selling_price|floatformat:0|intcomma }}
                                            </p>
                                        {% else %}
                                            <p class="text-xl font-bold text-blue-600">
                                                ₩{{ product.selling_price|floatformat:0|intcomma }}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </a>
                            
                            <!-- 빠른 액션 버튼 -->
                            <div class="p-4 pt-0 flex gap-2">
                                {% if product.stock_quantity > 0 %}
                                    <form method="post" action="{% url 'shop:add_to_cart' product.id %}" class="flex-1">
                                        {% csrf_token %}
                                        <input type="hidden" name="quantity" value="1">
                                        <button type="submit" 
                                                class="w-full px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition">
                                            <i class="fas fa-shopping-cart mr-1"></i>장바구니
                                        </button>
                                    </form>
                                {% else %}
                                    <button disabled 
                                            class="flex-1 px-3 py-2 bg-gray-300 text-gray-500 text-sm rounded-md cursor-not-allowed">
                                        품절
                                    </button>
                                {% endif %}
                                
                                <button class="px-3 py-2 border border-gray-300 text-gray-700 text-sm rounded-md hover:bg-gray-50 transition">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <!-- 페이지네이션 (추후 구현) -->
                {% comment %}
                <div class="mt-8 flex justify-center">
                    <!-- 페이지네이션 구현 예정 -->
                </div>
                {% endcomment %}
            {% else %}
                <!-- 검색 결과 없음 -->
                <div class="bg-white rounded-lg shadow-md p-12 text-center">
                    <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                    <p class="text-xl text-gray-600 mb-2">검색 결과가 없습니다</p>
                    <p class="text-gray-500 mb-6">다른 검색어로 다시 시도해보세요</p>
                    <a href="{% url 'shop:product_list' %}" 
                       class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        전체 상품 보기
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* line-clamp 유틸리티 클래스 (Tailwind CSS v3.0 이상에서는 기본 제공) */
.line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 추가 JavaScript 기능 (필요시)
</script>
{% endblock %}