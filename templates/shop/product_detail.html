{% extends 'shop/base.html' %}
{% load humanize %}
{% block title %}{{ product.name }} - {{ site_name }}{% endblock %}

{% block extra_css %}
<style>
    .thumbnail-image {
        cursor: pointer;
        transition: all 0.2s;
    }
    .thumbnail-image:hover {
        opacity: 0.8;
    }
    .thumbnail-image.active {
        border: 2px solid #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- 빵부스러기 네비게이션 -->
    <nav class="text-sm mb-6">
        <ol class="list-none p-0 inline-flex">
            <li class="flex items-center">
                <a href="{% url 'shop:home' %}" class="text-gray-600 hover:text-blue-600">홈</a>
                <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                    <path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/>
                </svg>
            </li>
            {% if product.category %}
            <li class="flex items-center">
                <a href="{% url 'shop:product_list' %}?category={{ product.category.id }}" class="text-gray-600 hover:text-blue-600">
                    {{ product.category.name }}
                </a>
                <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
                    <path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/>
                </svg>
            </li>
            {% endif %}
            <li>
                <span class="text-gray-700">{{ product.name }}</span>
            </li>
        </ol>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- 상품 이미지 -->
        <div>
            <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
                <div class="aspect-w-1 aspect-h-1">
                    {% with primary_image=product.images.first %}
                    {% if primary_image %}
                        <img id="mainImage" src="{{ primary_image.image.url }}" 
                             alt="{{ product.name }}" 
                             class="w-full h-96 object-contain">
                    {% else %}
                        <div class="w-full h-96 flex items-center justify-center bg-gray-100">
                            <i class="fas fa-image text-6xl text-gray-400"></i>
                        </div>
                    {% endif %}
                    {% endwith %}
                </div>
            </div>
            
            <!-- 썸네일 이미지들 -->
            {% if product.gallery_images.count > 1 %}
            <div class="grid grid-cols-4 gap-2">
                {% for image in product.gallery_images %}
                <div class="bg-white rounded-lg shadow-sm p-2">
                    <img src="{{ image.image.url }}" 
                         alt="{{ image.alt_text|default:product.name }}"
                         class="thumbnail-image w-full h-20 object-cover rounded {% if forloop.first %}active{% endif %}"
                         onclick="changeMainImage('{{ image.image.url }}', this)">
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- 상품 정보 -->
        <div>
            <div class="bg-white rounded-lg shadow-sm p-6">
                <!-- 브랜드 -->
                {% if product.brand %}
                <p class="text-sm text-gray-600 mb-2">{{ product.brand.name }}</p>
                {% endif %}
                
                <!-- 상품명 -->
                <h1 class="text-2xl font-bold text-gray-900 mb-4">{{ product.name }}</h1>
                
                <!-- 가격 -->
                <div class="mb-6">
                    {% if product.discount_price %}
                        <div class="flex items-center gap-3">
                            <span class="text-3xl font-bold text-blue-600">
                                ₩{{ product.effective_price|floatformat:0|intcomma }}
                            </span>
                            <span class="text-xl text-gray-500 line-through">
                                ₩{{ product.selling_price|floatformat:0|intcomma }}
                            </span>
                            <span class="bg-red-500 text-white px-2 py-1 rounded text-sm font-semibold">
                                {{ product.discount_percentage }}% OFF
                            </span>
                        </div>
                    {% else %}
                        <span class="text-3xl font-bold text-blue-600">
                            ₩{{ product.selling_price|floatformat:0|intcomma }}
                        </span>
                    {% endif %}
                </div>
                
                <!-- 간단 설명 -->
                {% if product.short_description %}
                <div class="mb-6">
                    <p class="text-gray-700">{{ product.short_description }}</p>
                </div>
                {% endif %}
                
                <!-- 상품 정보 -->
                <div class="border-t border-b py-4 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">상품코드:</span>
                            <span class="font-medium">{{ product.sku }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">재고상태:</span>
                            {% if product.stock_quantity > 10 %}
                                <span class="font-medium text-green-600">재고 있음</span>
                            {% elif product.stock_quantity > 0 %}
                                <span class="font-medium text-orange-600">재고 {{ product.stock_quantity }}개</span>
                            {% else %}
                                <span class="font-medium text-red-600">품절</span>
                            {% endif %}
                        </div>
                        {% if product.weight %}
                        <div>
                            <span class="text-gray-600">무게:</span>
                            <span class="font-medium">{{ product.weight }}g</span>
                        </div>
                        {% endif %}
                        <div>
                            <span class="text-gray-600">배송비:</span>
                            <span class="font-medium">무료배송</span>
                        </div>
                    </div>
                </div>
                
                <!-- 구매 옵션 -->
                {% if product.stock_quantity > 0 %}
                <form method="post" action="{% url 'shop:add_to_cart' product.id %}" class="mb-6">
                    {% csrf_token %}
                    <div class="flex items-center gap-4 mb-4">
                        <label class="text-gray-700">수량:</label>
                        <div class="flex items-center border rounded-lg">
                            <button type="button" onclick="decreaseQuantity()" 
                                    class="px-3 py-2 hover:bg-gray-100">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" name="quantity" id="quantity" value="1" min="1" 
                                   max="{{ product.stock_quantity }}"
                                   class="w-16 text-center py-2 focus:outline-none">
                            <button type="button" onclick="increaseQuantity({{ product.stock_quantity }})" 
                                    class="px-3 py-2 hover:bg-gray-100">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button type="submit" 
                                class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            <i class="fas fa-shopping-cart mr-2"></i>장바구니 담기
                        </button>
                        <button type="button" 
                                class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="bg-gray-100 text-center py-4 rounded-lg mb-6">
                    <p class="text-gray-600">현재 품절된 상품입니다.</p>
                </div>
                {% endif %}
                
                <!-- 안내 정보 -->
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-check-circle text-green-500"></i>
                        <span>100% 정품 보증</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-truck text-blue-500"></i>
                        <span>2-3일 이내 배송</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <i class="fas fa-undo text-orange-500"></i>
                        <span>14일 이내 교환/반품 가능</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 상품 상세 설명 -->
    <div class="mt-12">
        <div class="bg-white rounded-lg shadow-sm">
            <div class="border-b" x-data="{ activeTab: 'description' }">
                <nav class="-mb-px flex">
                    <button @click="activeTab = 'description'" 
                            :class="{'border-blue-600 text-blue-600': activeTab === 'description'}"
                            class="py-4 px-6 border-b-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        상품설명
                    </button>
                    <button @click="activeTab = 'details'" 
                            :class="{'border-blue-600 text-blue-600': activeTab === 'details'}"
                            class="py-4 px-6 border-b-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        상세정보
                    </button>
                    <button @click="activeTab = 'shipping'" 
                            :class="{'border-blue-600 text-blue-600': activeTab === 'shipping'}"
                            class="py-4 px-6 border-b-2 font-medium text-gray-600 hover:text-blue-600 transition">
                        배송/교환/반품
                    </button>
                </nav>
            </div>
            
            <div class="p-6">
                <!-- 상품설명 탭 -->
                <div x-show="activeTab === 'description'" class="prose max-w-none">
                    {% if product.description %}
                        {{ product.description|linebreaks }}
                    {% else %}
                        <p class="text-gray-500">상품 설명이 준비 중입니다.</p>
                    {% endif %}
                    
                    <!-- 상세 이미지 표시 -->
                    {% if product.detail_images %}
                        <div class="mt-8 space-y-4">
                            {% for image in product.detail_images %}
                            <div class="text-center">
                                <img src="{{ image.image.url }}" 
                                     alt="{{ image.alt_text|default:product.name }}"
                                     class="mx-auto">
                            </div>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <!-- 상세정보 탭 -->
                <div x-show="activeTab === 'details'" style="display: none;">
                    <table class="w-full">
                        <tbody>
                            <tr class="border-b">
                                <td class="py-3 px-4 bg-gray-50 font-medium w-1/4">상품코드</td>
                                <td class="py-3 px-4">{{ product.sku }}</td>
                            </tr>
                            {% if product.brand %}
                            <tr class="border-b">
                                <td class="py-3 px-4 bg-gray-50 font-medium">브랜드</td>
                                <td class="py-3 px-4">{{ product.brand.name }}</td>
                            </tr>
                            {% endif %}
                            {% if product.category %}
                            <tr class="border-b">
                                <td class="py-3 px-4 bg-gray-50 font-medium">카테고리</td>
                                <td class="py-3 px-4">{{ product.category.name }}</td>
                            </tr>
                            {% endif %}
                            {% if product.weight %}
                            <tr class="border-b">
                                <td class="py-3 px-4 bg-gray-50 font-medium">무게</td>
                                <td class="py-3 px-4">{{ product.weight }}g</td>
                            </tr>
                            {% endif %}
                            {% if product.dimensions_length and product.dimensions_width and product.dimensions_height %}
                            <tr class="border-b">
                                <td class="py-3 px-4 bg-gray-50 font-medium">크기</td>
                                <td class="py-3 px-4">
                                    {{ product.dimensions_length }} x {{ product.dimensions_width }} x {{ product.dimensions_height }} cm
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 배송/교환/반품 탭 -->
                <div x-show="activeTab === 'shipping'" style="display: none;">
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">배송 안내</h4>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                <li>배송비: 무료배송</li>
                                <li>배송기간: 주문 후 2-3일 이내 (주말/공휴일 제외)</li>
                                <li>배송업체: CJ대한통운</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold mb-2">교환/반품 안내</h4>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                <li>교환/반품 기간: 상품 수령 후 14일 이내</li>
                                <li>교환/반품 비용: 고객 변심 시 왕복 배송비 고객 부담</li>
                                <li>교환/반품 불가: 상품 훼손, 태그 제거, 사용 흔적이 있는 경우</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 관련 상품 -->
    {% if related_products %}
    <div class="mt-12">
        <h2 class="text-2xl font-bold mb-6">관련 상품</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            {% for related in related_products %}
            <div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-lg transition">
                <a href="{% url 'shop:product_detail' related.id %}">
                    <div class="aspect-w-1 aspect-h-1">
                        {% with primary_image=related.images.first %}
                        {% if primary_image %}
                            <img src="{{ primary_image.image.url }}" 
                                 alt="{{ related.name }}" 
                                 class="w-full h-48 object-cover">
                        {% else %}
                            <div class="w-full h-48 flex items-center justify-center bg-gray-100">
                                <i class="fas fa-image text-4xl text-gray-400"></i>
                            </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                    <div class="p-4">
                        <h3 class="font-medium text-gray-800 mb-1 truncate">{{ related.name }}</h3>
                        <p class="text-lg font-bold text-blue-600">
                            ₩{{ related.effective_price|floatformat:0|intcomma }}
                        </p>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function changeMainImage(imageUrl, thumbnailElement) {
    document.getElementById('mainImage').src = imageUrl;
    
    // 모든 썸네일에서 active 클래스 제거
    document.querySelectorAll('.thumbnail-image').forEach(img => {
        img.classList.remove('active');
    });
    
    // 클릭한 썸네일에 active 클래스 추가
    thumbnailElement.classList.add('active');
}

function decreaseQuantity() {
    const input = document.getElementById('quantity');
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
        input.value = currentValue - 1;
    }
}

function increaseQuantity(maxQuantity) {
    const input = document.getElementById('quantity');
    const currentValue = parseInt(input.value);
    if (currentValue < maxQuantity) {
        input.value = currentValue + 1;
    }
}
</script>
{% endblock %}