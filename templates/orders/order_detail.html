{% extends 'base.html' %}
{% load humanize %}

{% comment %} templates/orders/order_detail.html - Complete Enhanced Version {% endcomment %}

{% block title %}주문 상세 - {{ order.order_number }} - Shopuda ERP{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<meta name="csrf-token" content="{{ csrf_token }}">
<style>
/* 인쇄 전용 스타일 */
@media print {
    body * {
        visibility: hidden;
    }
    
    .print-area, .print-area * {
        visibility: visible;
    }
    
    .print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 20px;
    }
    
    .no-print {
        display: none !important;
    }
    
    /* 인쇄 시 색상 조정 */
    .print-header {
        background: #f8f9fa !important;
        color: #000 !important;
        border: 2px solid #000 !important;
        text-align: center;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .print-company-info {
        text-align: center;
        margin-bottom: 30px;
        border-bottom: 2px solid #000;
        padding-bottom: 20px;
    }
    
    .print-customer-info {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #000;
    }
    
    .print-table {
        border-collapse: collapse;
        width: 100%;
        margin: 20px 0;
    }
    
    .print-table th,
    .print-table td {
        border: 1px solid #000 !important;
        padding: 8px !important;
        text-align: left;
    }
    
    .print-table th {
        background-color: #f0f0f0 !important;
        font-weight: bold;
    }
    
    .print-total {
        font-size: 18px !important;
        font-weight: bold !important;
        text-align: right !important;
        margin-top: 20px !important;
        border-top: 2px solid #000;
        padding-top: 10px;
    }
    
    .print-footer {
        margin-top: 40px;
        text-align: center;
        font-size: 12px;
        color: #666;
        border-top: 1px solid #000;
        padding-top: 20px;
    }
    
    .print-timeline {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #000;
    }
    
    .print-timeline h3 {
        margin-top: 0;
        border-bottom: 1px solid #000;
        padding-bottom: 10px;
    }
}

/* 이메일 모달 스타일 */
.email-modal {
    max-height: 90vh;
    overflow-y: auto;
}

.email-template-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.template-option {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.template-option:hover {
    border-color: #3b82f6;
    background-color: #f8fafc;
}

.template-option.selected {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.email-preview {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    max-height: 300px;
    overflow-y: auto;
}

/* 애니메이션 */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fadeInUp 0.6s ease forwards;
    opacity: 0;
}

/* 로딩 스피너 */
.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Alpine.js x-cloak */
[x-cloak] { 
    display: none !important; 
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 transition-colors duration-300" x-data="orderDetail()">
    <!-- Breadcrumb Navigation -->
    <nav class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700" aria-label="Breadcrumb">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <ol class="flex items-center space-x-2 lg:space-x-4 py-4">
                <li>
                    <div>
                        <a href="{% url 'dashboard:home' %}" 
                           class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:text-gray-600 dark:focus:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 rounded-sm transition-colors duration-200"
                           aria-label="홈으로 이동">
                            <i class="fas fa-home h-4 w-4 lg:h-5 lg:w-5" aria-hidden="true"></i>
                            <span class="sr-only">Home</span>
                        </a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right h-4 w-4 lg:h-5 lg:w-5 text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
                        <a href="{% url 'orders:list' %}" 
                           class="ml-2 lg:ml-4 text-xs lg:text-sm font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 focus:text-gray-700 dark:focus:text-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 rounded-sm transition-colors duration-200">
                            주문 관리
                        </a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <i class="fas fa-chevron-right h-4 w-4 lg:h-5 lg:w-5 text-gray-400 dark:text-gray-500" aria-hidden="true"></i>
                        <span class="ml-2 lg:ml-4 text-xs lg:text-sm font-medium text-gray-500 dark:text-gray-400">{{ order.order_number }}</span>
                    </div>
                </li>
            </ol>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-8">
        <div class="space-y-6 lg:space-y-8">
            <!-- Page Header -->
            <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 px-6 py-8">
                    <div class="flex flex-col space-y-4 lg:flex-row lg:items-center lg:justify-between lg:space-y-0">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                                <i class="fas fa-shopping-cart text-white text-2xl"></i>
                            </div>
                            <div>
                                <h1 class="text-2xl lg:text-3xl font-bold text-white">주문 상세</h1>
                                <p class="text-blue-100 font-medium">주문번호: {{ order.order_number }}</p>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-3 lg:flex-row lg:items-center lg:space-y-0 lg:space-x-4">
                            <!-- Status Badge -->
                            <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold backdrop-blur-sm
                                {% if order.status == 'PENDING' %}bg-yellow-500/20 text-yellow-100 border border-yellow-300/30
                                {% elif order.status == 'PROCESSING' %}bg-blue-500/20 text-blue-100 border border-blue-300/30
                                {% elif order.status == 'SHIPPED' %}bg-purple-500/20 text-purple-100 border border-purple-300/30
                                {% elif order.status == 'DELIVERED' %}bg-green-500/20 text-green-100 border border-green-300/30
                                {% elif order.status == 'CANCELLED' %}bg-red-500/20 text-red-100 border border-red-300/30
                                {% else %}bg-gray-500/20 text-gray-100 border border-gray-300/30{% endif %}">
                                <i class="fas fa-circle w-2 h-2 mr-2"></i>
                                {{ order.get_status_display }}
                            </span>
                            
                            <!-- Action Buttons -->
                            <div class="flex space-x-2">
                                <button type="button" 
                                        @click="updateStatus()"
                                        class="inline-flex items-center px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/30 rounded-lg text-white font-medium transition-all duration-200 hover:scale-105 hover:shadow-lg">
                                    <i class="fas fa-edit mr-2"></i>
                                    상태 변경
                                </button>
                                <a href="{% url 'orders:edit' order.pk %}" 
                                   class="inline-flex items-center px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm border border-white/30 rounded-lg text-white font-medium transition-all duration-200 hover:scale-105 hover:shadow-lg">
                                    <i class="fas fa-pencil-alt mr-2"></i>
                                    수정
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
                <!-- Main Content -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Order Items -->
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-box text-indigo-600 dark:text-indigo-400 mr-3"></i>
                                주문 상품
                            </h3>
                        </div>
                        
                        <div class="overflow-hidden">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-900/50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">상품</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">수량</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">단가</th>
                                        <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">합계</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    {% for item in order.items.all %}
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-200">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-12 w-12">
                                                    {% if item.product.image %}
                                                        <img class="h-12 w-12 rounded-lg object-cover shadow-sm" 
                                                             src="{{ item.product.image.url }}" 
                                                             alt="{{ item.product.name }}">
                                                    {% else %}
                                                        <div class="h-12 w-12 rounded-lg bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-600 dark:to-gray-700 flex items-center justify-center">
                                                            <i class="fas fa-image text-gray-400 dark:text-gray-500"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                                        {{ item.product.name }}
                                                    </div>
                                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                                        SKU: {{ item.product.sku }}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200">
                                                {{ item.quantity }}개
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white font-medium">
                                            ₩{{ item.unit_price|floatformat:0|intcomma }}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white">
                                            ₩{{ item.total_price|floatformat:0|intcomma }}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" class="px-6 py-12 text-center">
                                            <div class="flex flex-col items-center space-y-3">
                                                <i class="fas fa-box-open text-4xl text-gray-300 dark:text-gray-600"></i>
                                                <p class="text-gray-500 dark:text-gray-400">주문 상품이 없습니다.</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Order Summary -->
                        <div class="bg-gray-50 dark:bg-gray-900/50 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-gray-900 dark:text-white">총 주문 금액</span>
                                <span class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">₩{{ order.total_amount|floatformat:0|intcomma }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Order Timeline -->
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-clock text-green-600 dark:text-green-400 mr-3"></i>
                                주문 진행 상황
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="flow-root">
                                <ul class="-mb-8">
                                    <!-- Order Created -->
                                    <li>
                                        <div class="relative pb-8">
                                            <div class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200 dark:bg-gray-600" aria-hidden="true"></div>
                                            <div class="relative flex items-start space-x-3">
                                                <div>
                                                    <span class="h-10 w-10 rounded-full bg-green-500 flex items-center justify-center ring-4 ring-white dark:ring-gray-800 shadow-lg">
                                                        <i class="fas fa-plus h-4 w-4 text-white" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900 dark:text-white">주문 생성</p>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">새로운 주문이 접수되었습니다.</p>
                                                    </div>
                                                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                                        <time datetime="{{ order.created_at|date:'c' }}">{{ order.created_at|date:'Y년 m월 d일 H:i' }}</time>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>

                                    <!-- Processing Status -->
                                    {% if order.status != 'PENDING' %}
                                    <li>
                                        <div class="relative pb-8">
                                            <div class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200 dark:bg-gray-600" aria-hidden="true"></div>
                                            <div class="relative flex items-start space-x-3">
                                                <div>
                                                    <span class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center ring-4 ring-white dark:ring-gray-800 shadow-lg">
                                                        <i class="fas fa-cog h-4 w-4 text-white" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900 dark:text-white">처리 시작</p>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">주문 처리가 시작되었습니다.</p>
                                                    </div>
                                                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                                        <time datetime="{{ order.updated_at|date:'c' }}">{{ order.updated_at|date:'Y년 m월 d일 H:i' }}</time>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endif %}

                                    <!-- Shipped Status -->
                                    {% if order.status == 'SHIPPED' or order.status == 'DELIVERED' %}
                                    <li>
                                        <div class="relative pb-8">
                                            {% if order.status != 'DELIVERED' %}<div class="absolute top-5 left-5 -ml-px h-full w-0.5 bg-gray-200 dark:bg-gray-600" aria-hidden="true"></div>{% endif %}
                                            <div class="relative flex items-start space-x-3">
                                                <div>
                                                    <span class="h-10 w-10 rounded-full bg-purple-500 flex items-center justify-center ring-4 ring-white dark:ring-gray-800 shadow-lg">
                                                        <i class="fas fa-truck h-4 w-4 text-white" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900 dark:text-white">배송 시작</p>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">상품이 배송 중입니다.</p>
                                                        {% if order.tracking_number %}
                                                        <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">추적번호: {{ order.tracking_number }}</p>
                                                        {% endif %}
                                                    </div>
                                                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                                        <time datetime="{{ order.shipped_date|date:'c' }}">{{ order.shipped_date|date:'Y년 m월 d일 H:i' }}</time>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endif %}

                                    <!-- Delivered Status -->
                                    {% if order.status == 'DELIVERED' %}
                                    <li>
                                        <div class="relative">
                                            <div class="relative flex items-start space-x-3">
                                                <div>
                                                    <span class="h-10 w-10 rounded-full bg-green-600 flex items-center justify-center ring-4 ring-white dark:ring-gray-800 shadow-lg">
                                                        <i class="fas fa-check h-4 w-4 text-white" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900 dark:text-white">배송 완료</p>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">상품이 성공적으로 배송되었습니다.</p>
                                                    </div>
                                                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                                        <time datetime="{{ order.delivered_date|date:'c' }}">{{ order.delivered_date|date:'Y년 m월 d일 H:i' }}</time>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endif %}

                                    <!-- Cancelled Status -->
                                    {% if order.status == 'CANCELLED' %}
                                    <li>
                                        <div class="relative">
                                            <div class="relative flex items-start space-x-3">
                                                <div>
                                                    <span class="h-10 w-10 rounded-full bg-red-500 flex items-center justify-center ring-4 ring-white dark:ring-gray-800 shadow-lg">
                                                        <i class="fas fa-times h-4 w-4 text-white" aria-hidden="true"></i>
                                                    </span>
                                                </div>
                                                <div class="min-w-0 flex-1">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900 dark:text-white">주문 취소</p>
                                                        <p class="text-sm text-gray-500 dark:text-gray-400">주문이 취소되었습니다.</p>
                                                    </div>
                                                    <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                                        <time datetime="{{ order.cancelled_date|date:'c' }}">{{ order.cancelled_date|date:'Y년 m월 d일 H:i' }}</time>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <!-- Customer Information -->
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-user text-blue-600 dark:text-blue-400 mr-3"></i>
                                고객 정보
                            </h3>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                    <span class="text-white font-bold text-sm">{{ order.customer_name|first|upper }}</span>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">{{ order.customer_name }}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">고객</p>
                                </div>
                            </div>
                            
                            {% if order.customer_email %}
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                                <i class="fas fa-envelope text-gray-400 dark:text-gray-500"></i>
                                <a href="mailto:{{ order.customer_email }}" 
                                   class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200">
                                    {{ order.customer_email }}
                                </a>
                            </div>
                            {% endif %}
                            
                            {% if order.customer_phone %}
                            <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                                <i class="fas fa-phone text-gray-400 dark:text-gray-500"></i>
                                <a href="tel:{{ order.customer_phone }}" 
                                   class="text-sm text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200">
                                    {{ order.customer_phone }}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Shipping Information -->
                    {% if order.shipping_address %}
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-map-marker-alt text-green-600 dark:text-green-400 mr-3"></i>
                                배송 정보
                            </h3>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="space-y-2">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">배송지 주소</dt>
                                <dd class="text-sm text-gray-900 dark:text-white leading-relaxed">
                                    {{ order.shipping_address }}
                                </dd>
                            </div>
                            
                            {% if order.shipping_zipcode %}
                            <div class="space-y-2">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">우편번호</dt>
                                <dd class="text-sm text-gray-900 dark:text-white">{{ order.shipping_zipcode }}</dd>
                            </div>
                            {% endif %}
                            
                            {% if order.shipping_method %}
                            <div class="space-y-2">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">배송 방법</dt>
                                <dd class="text-sm text-gray-900 dark:text-white">{{ order.get_shipping_method_display }}</dd>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Order Information -->
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-info-circle text-purple-600 dark:text-purple-400 mr-3"></i>
                                주문 정보
                            </h3>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">주문일시</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white mt-1">{{ order.created_at|date:'Y-m-d' }}</dd>
                                </div>
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">플랫폼</dt>
                                    <dd class="text-sm text-gray-900 dark:text-white mt-1">{{ order.platform.name|default:'직접 주문' }}</dd>
                                </div>
                            </div>
                            
                            {% if order.notes %}
                            <div class="space-y-2">
                                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">주문 메모</dt>
                                <dd class="text-sm text-gray-900 dark:text-white leading-relaxed p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                                    {{ order.notes }}
                                </dd>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden transition-all duration-300">
                        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                                <i class="fas fa-bolt text-yellow-600 dark:text-yellow-400 mr-3"></i>
                                빠른 작업
                            </h3>
                        </div>
                        
                        <div class="p-6 space-y-3">
                            <button type="button" 
                                    @click="printOrder()"
                                    class="w-full flex items-center justify-center px-4 py-3 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-all duration-200 hover:scale-105 hover:shadow-md">
                                <i class="fas fa-print mr-2"></i>
                                주문서 인쇄
                            </button>
                            
                            <button type="button" 
                                    @click="showEmailModal = true"
                                    :disabled="!hasCustomerEmail"
                                    class="w-full flex items-center justify-center px-4 py-3 bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 dark:hover:bg-blue-900/50 text-blue-700 dark:text-blue-300 rounded-lg transition-all duration-200 hover:scale-105 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                                <i class="fas fa-envelope mr-2"></i>
                                이메일 발송
                            </button>
                            
                            {% if order.status == 'SHIPPED' and order.tracking_number %}
                            <button type="button" 
                                    @click="trackPackage()"
                                    class="w-full flex items-center justify-center px-4 py-3 bg-green-100 dark:bg-green-900/30 hover:bg-green-200 dark:hover:bg-green-900/50 text-green-700 dark:text-green-300 rounded-lg transition-all duration-200 hover:scale-105 hover:shadow-md">
                                <i class="fas fa-truck mr-2"></i>
                                배송 추적
                            </button>
                            {% endif %}
                            
                            {% if order.status != 'CANCELLED' and order.status != 'DELIVERED' %}
                            <button type="button" 
                                    @click="cancelOrder()"
                                    class="w-full flex items-center justify-center px-4 py-3 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 rounded-lg transition-all duration-200 hover:scale-105 hover:shadow-md">
                                <i class="fas fa-times mr-2"></i>
                                주문 취소
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 인쇄용 숨겨진 영역 -->
    <div class="print-area" style="display: none;">
        <div class="print-company-info">
            <h1>📦 Shopuda ERP</h1>
            <p>온라인 쇼핑몰 통합 관리 시스템</p>
            <p>주소: 서울특별시 강남구 테헤란로 123</p>
            <p>전화: 02-1234-5678 | 이메일: info@shopuda.com</p>
        </div>
        
        <div class="print-header">
            <h2>📋 주문서</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                <div>
                    <strong>주문번호:</strong> {{ order.order_number }}<br>
                    <strong>주문일시:</strong> {{ order.created_at|date:"Y년 m월 d일 H:i" }}<br>
                    <strong>주문상태:</strong> {{ order.get_status_display }}
                </div>
                <div>
                    {% if order.platform %}
                    <strong>플랫폼:</strong> {{ order.platform.name }}<br>
                    {% endif %}
                    {% if order.tracking_number %}
                    <strong>운송장번호:</strong> {{ order.tracking_number }}<br>
                    {% endif %}
                    <strong>인쇄일시:</strong> <span id="print-date"></span>
                </div>
            </div>
        </div>
        
        <div class="print-customer-info">
            <h3>👤 고객 정보</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <strong>고객명:</strong> {{ order.customer_name }}<br>
                    {% if order.customer_email %}
                    <strong>이메일:</strong> {{ order.customer_email }}<br>
                    {% endif %}
                    {% if order.customer_phone %}
                    <strong>전화번호:</strong> {{ order.customer_phone }}
                    {% endif %}
                </div>
                <div>
                    {% if order.shipping_address %}
                    <strong>배송지 주소:</strong><br>
                    {{ order.shipping_address }}<br>
                    {% if order.shipping_zipcode %}
                    우편번호: {{ order.shipping_zipcode }}
                    {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <table class="print-table">
            <thead>
                <tr>
                    <th>상품명</th>
                    <th>SKU</th>
                    <th>수량</th>
                    <th>단가</th>
                    <th>합계</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order.items.all %}
                <tr>
                    <td>{{ item.product.name }}</td>
                    <td>{{ item.product.sku }}</td>
                    <td>{{ item.quantity }}개</td>
                    <td>₩{{ item.unit_price|floatformat:0|intcomma }}</td>
                    <td>₩{{ item.total_price|floatformat:0|intcomma }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <div class="print-total">
            총 주문 금액: ₩{{ order.total_amount|floatformat:0|intcomma }}
        </div>
        
        <!-- 주문 진행 상황 (인쇄용) -->
        <div class="print-timeline">
            <h3>📈 주문 진행 상황</h3>
            <ul>
                <li>✅ 주문 생성: {{ order.created_at|date:"Y년 m월 d일 H:i" }}</li>
                {% if order.status != 'PENDING' %}
                <li>🔄 처리 시작: {{ order.updated_at|date:"Y년 m월 d일 H:i" }}</li>
                {% endif %}
                {% if order.status == 'SHIPPED' or order.status == 'DELIVERED' %}
                <li>🚚 배송 시작: {{ order.shipped_date|date:"Y년 m월 d일 H:i" }}
                    {% if order.tracking_number %} (추적번호: {{ order.tracking_number }}){% endif %}
                </li>
                {% endif %}
                {% if order.status == 'DELIVERED' %}
                <li>📦 배송 완료: {{ order.delivered_date|date:"Y년 m월 d일 H:i" }}</li>
                {% endif %}
                {% if order.status == 'CANCELLED' %}
                <li>❌ 주문 취소: {{ order.cancelled_date|date:"Y년 m월 d일 H:i" }}</li>
                {% endif %}
            </ul>
        </div>
        
        {% if order.notes %}
        <div style="margin-top: 30px;">
            <h4>📝 주문 메모</h4>
            <p style="border: 1px solid #ccc; padding: 10px; background: #f9f9f9;">{{ order.notes }}</p>
        </div>
        {% endif %}
        
        <div class="print-footer">
            <p>본 주문서는 Shopuda ERP 시스템에서 자동 생성되었습니다.</p>
            <p>문의사항이 있으시면 고객센터(02-1234-5678)로 연락주시기 바랍니다.</p>
            <p style="margin-top: 10px;">© 2024 Shopuda. All rights reserved.</p>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div x-show="showStatusModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" 
                 @click="showStatusModal = false"></div>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-2xl px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 dark:bg-blue-900/30 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-edit text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            주문 상태 변경
                        </h3>
                        <div class="mt-4">
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">새로운 상태</label>
                                    <select x-model="newStatus" 
                                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                                        <option value="PENDING">대기</option>
                                        <option value="PROCESSING">처리중</option>
                                        <option value="SHIPPED">배송중</option>
                                        <option value="DELIVERED">배송완료</option>
                                        <option value="CANCELLED">취소</option>
                                    </select>
                                </div>
                                
                                <div x-show="newStatus === 'SHIPPED'">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">추적번호 (선택사항)</label>
                                    <input type="text" x-model="trackingNumber" 
                                           placeholder="추적번호를 입력하세요"
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" 
                            @click="confirmStatusUpdate()"
                            class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-blue-600 hover:bg-blue-700 text-base font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm transition-all duration-200 hover:scale-105">
                        변경하기
                    </button>
                    <button type="button" 
                            @click="showStatusModal = false"
                            class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm transition-all duration-200">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div x-show="showEmailModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" 
                 @click="showEmailModal = false"></div>

            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-2xl px-6 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full sm:p-6 email-modal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-envelope text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <h3 class="text-lg leading-6 font-semibold text-gray-900 dark:text-white">
                            📧 이메일 발송
                        </h3>
                    </div>
                    <button @click="showEmailModal = false" 
                            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 text-xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <!-- 수신자 정보 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📤 수신자</label>
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-900/50 rounded-lg">
                            <i class="fas fa-user text-gray-400"></i>
                            <div>
                                <p class="font-medium text-gray-900 dark:text-white">{{ order.customer_name }}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ order.customer_email|default:"이메일 없음" }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 이메일 템플릿 선택 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">📋 이메일 템플릿</label>
                        <div class="email-template-selector">
                            <div class="template-option" 
                                 :class="{ 'selected': emailTemplate === 'order_confirmation' }"
                                 @click="selectEmailTemplate('order_confirmation')">
                                <i class="fas fa-check-circle text-green-500 mb-2 text-xl"></i>
                                <h4 class="font-medium">✅ 주문 확인</h4>
                                <p class="text-xs text-gray-500">주문 접수 확인 메일</p>
                            </div>
                            
                            <div class="template-option" 
                                 :class="{ 'selected': emailTemplate === 'shipping_notification' }"
                                 @click="selectEmailTemplate('shipping_notification')">
                                <i class="fas fa-truck text-blue-500 mb-2 text-xl"></i>
                                <h4 class="font-medium">🚚 배송 안내</h4>
                                <p class="text-xs text-gray-500">배송 시작 알림 메일</p>
                            </div>
                            
                            <div class="template-option" 
                                 :class="{ 'selected': emailTemplate === 'delivery_complete' }"
                                 @click="selectEmailTemplate('delivery_complete')">
                                <i class="fas fa-gift text-purple-500 mb-2 text-xl"></i>
                                <h4 class="font-medium">📦 배송 완료</h4>
                                <p class="text-xs text-gray-500">배송 완료 알림 메일</p>
                            </div>
                            
                            <div class="template-option" 
                                 :class="{ 'selected': emailTemplate === 'custom' }"
                                 @click="selectEmailTemplate('custom')">
                                <i class="fas fa-edit text-orange-500 mb-2 text-xl"></i>
                                <h4 class="font-medium">✏️ 사용자 정의</h4>
                                <p class="text-xs text-gray-500">직접 작성하기</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 이메일 제목 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📝 제목</label>
                        <input type="text" 
                               x-model="emailSubject" 
                               class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-colors duration-200"
                               placeholder="이메일 제목을 입력하세요">
                    </div>
                    
                    <!-- 이메일 내용 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">📄 내용</label>
                        <textarea x-model="emailContent" 
                                  rows="8"
                                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white transition-colors duration-200 resize-none"
                                  placeholder="이메일 내용을 입력하세요"></textarea>
                    </div>
                    
                    <!-- 이메일 미리보기 -->
                    <div x-show="emailTemplate !== 'custom'" class="email-preview">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-3">👀 미리보기</h4>
                        <div class="prose dark:prose-invert max-w-none">
                            <div x-html="getEmailPreview()"></div>
                        </div>
                    </div>
                    
                    <!-- 추가 옵션 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" x-model="includeOrderDetails" 
                                   class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">📋 주문 상세 정보 포함</span>
                        </label>
                        
                        <label class="flex items-center">
                            <input type="checkbox" x-model="sendCopyToAdmin" 
                                   class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">👨‍💼 관리자에게 사본 발송</span>
                        </label>
                    </div>
                </div>
                
                <!-- 모달 액션 버튼 -->
                <div class="mt-6 flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-3">
                    <button type="button" 
                            @click="showEmailModal = false"
                            class="w-full sm:w-auto px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                        ❌ 취소
                    </button>
                    
                    <button type="button" 
                            @click="previewEmail()"
                            class="w-full sm:w-auto px-4 py-2 border border-blue-300 rounded-lg shadow-sm bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900/50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                        <i class="fas fa-eye mr-2"></i>
                        👀 미리보기
                    </button>
                    
                    <button type="button" 
                            @click="sendEmail()"
                            :disabled="!emailSubject || !emailContent || sendingEmail || !hasCustomerEmail"
                            class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-lg shadow-sm bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 disabled:cursor-not-allowed">
                        <span x-show="!sendingEmail" class="flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i>
                            📧 이메일 발송
                        </span>
                        <span x-show="sendingEmail" x-cloak class="flex items-center justify-center">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            📤 발송 중...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function orderDetail() {
    return {
        showStatusModal: false,
        showEmailModal: false,
        newStatus: '{{ order.status }}',
        trackingNumber: '{{ order.tracking_number|default:"" }}',
        
        // 이메일 관련 데이터
        emailTemplate: 'order_confirmation',
        emailSubject: '',
        emailContent: '',
        includeOrderDetails: true,
        sendCopyToAdmin: false,
        sendingEmail: false,
        hasCustomerEmail: {{ order.customer_email|yesno:"true,false" }},
        
        // 이메일 템플릿 데이터
        emailTemplates: {
            order_confirmation: {
                subject: '[Shopuda] 주문이 접수되었습니다 - {{ order.order_number }}',
                content: `안녕하세요, {{ order.customer_name }}님! 👋

Shopuda에서 주문해 주셔서 감사합니다.
주문이 성공적으로 접수되었으며, 현재 처리 중입니다.

📋 주문 정보
• 주문번호: {{ order.order_number }}
• 주문일시: {{ order.created_at|date:"Y년 m월 d일 H:i" }}
• 주문상태: {{ order.get_status_display }}

💰 결제 금액
총 주문 금액: ₩{{ order.total_amount|floatformat:0|intcomma }}

📦 배송 정보
{% if order.shipping_address %}배송지: {{ order.shipping_address }}{% endif %}
{% if order.shipping_method %}배송 방법: {{ order.get_shipping_method_display }}{% endif %}

주문 처리가 완료되면 배송 안내 메일을 별도로 발송해 드립니다.

문의사항이 있으시면 언제든지 연락주세요.

감사합니다.
Shopuda 고객센터 📞`
            },
            shipping_notification: {
                subject: '[Shopuda] 상품이 배송 시작되었습니다 - {{ order.order_number }}',
                content: `안녕하세요, {{ order.customer_name }}님! 🚚

주문하신 상품의 배송이 시작되었습니다.

📋 주문 정보
• 주문번호: {{ order.order_number }}
• 주문일시: {{ order.created_at|date:"Y년 m월 d일 H:i" }}

🚚 배송 정보
{% if order.tracking_number %}• 운송장 번호: {{ order.tracking_number }}{% endif %}
{% if order.shipping_address %}• 배송지: {{ order.shipping_address }}{% endif %}
• 예상 배송일: 2-3일 내

{% if order.tracking_number %}운송장 번호로 배송 상황을 실시간으로 확인하실 수 있습니다.{% endif %}

안전하게 포장하여 빠른 시일 내에 배송해 드리겠습니다.

감사합니다.
Shopuda 고객센터 📦`
            },
            delivery_complete: {
                subject: '[Shopuda] 배송이 완료되었습니다 - {{ order.order_number }}',
                content: `안녕하세요, {{ order.customer_name }}님! 📦

주문하신 상품이 성공적으로 배송 완료되었습니다.

📋 주문 정보
• 주문번호: {{ order.order_number }}
• 배송완료일: {{ order.delivered_date|date:"Y년 m월 d일 H:i" }}

🎁 상품을 받으셨다면
상품에 문제가 있거나 궁금한 점이 있으시면 언제든지 고객센터로 연락주세요.

📝 리뷰 작성
만족하셨다면 상품 리뷰를 남겨주시면 다른 고객들에게 큰 도움이 됩니다.

앞으로도 Shopuda를 이용해 주셔서 감사합니다.

감사합니다.
Shopuda 고객센터 ⭐`
            }
        },
        
        init() {
            this.selectEmailTemplate('order_confirmation');
        },
        
        selectEmailTemplate(template) {
            this.emailTemplate = template;
            if (template !== 'custom' && this.emailTemplates[template]) {
                this.emailSubject = this.emailTemplates[template].subject;
                this.emailContent = this.emailTemplates[template].content;
            } else if (template === 'custom') {
                this.emailSubject = '';
                this.emailContent = '';
            }
        },
        
        getEmailPreview() {
            return this.emailContent.replace(/\n/g, '<br>');
        },
        
        async sendEmail() {
            if (!this.emailSubject || !this.emailContent) {
                this.showAlert('error', '입력 오류', '제목과 내용을 모두 입력해주세요.');
                return;
            }
            
            if (!this.hasCustomerEmail) {
                this.showAlert('error', '이메일 오류', '고객 이메일 주소가 없습니다.');
                return;
            }
            
            this.sendingEmail = true;
            
            try {
                const emailData = {
                    recipient_email: '{{ order.customer_email }}',
                    recipient_name: '{{ order.customer_name }}',
                    subject: this.emailSubject,
                    content: this.emailContent,
                    template: this.emailTemplate,
                    include_order_details: this.includeOrderDetails,
                    send_copy_to_admin: this.sendCopyToAdmin,
                    order_id: {{ order.pk }}
                };
                
                const response = await fetch(`{% url 'orders:send_email' order.pk %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(emailData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.showAlert('success', '발송 완료', '이메일이 성공적으로 발송되었습니다.');
                    this.showEmailModal = false;
                } else {
                    this.showAlert('error', '발송 실패', data.message || '이메일 발송에 실패했습니다.');
                }
            } catch (error) {
                console.error('Email send error:', error);
                this.showAlert('error', '네트워크 오류', '이메일 발송 중 오류가 발생했습니다.');
            } finally {
                this.sendingEmail = false;
            }
        },
        
        previewEmail() {
            // 이메일 미리보기를 새 창에서 열기
            const previewWindow = window.open('', '_blank', 'width=700,height=900,scrollbars=yes');
            const orderDetails = this.includeOrderDetails ? this.generateOrderDetailsHtml() : '';
            
            previewWindow.document.write(`
                <html>
                    <head>
                        <title>📧 이메일 미리보기</title>
                        <style>
                            body { 
                                font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, sans-serif; 
                                line-height: 1.6; 
                                margin: 0; 
                                padding: 20px;
                                background: #f9fafb;
                                color: #374151;
                            }
                            .email-container {
                                max-width: 600px;
                                margin: 0 auto;
                                background: white;
                                padding: 30px;
                                border-radius: 12px;
                                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            }
                            .header {
                                text-align: center;
                                border-bottom: 3px solid #3b82f6;
                                padding-bottom: 20px;
                                margin-bottom: 30px;
                            }
                            .logo {
                                font-size: 28px;
                                font-weight: bold;
                                color: #3b82f6;
                                margin-bottom: 10px;
                            }
                            .content {
                                white-space: pre-line;
                                margin-bottom: 30px;
                            }
                            .footer {
                                margin-top: 30px;
                                padding-top: 20px;
                                border-top: 2px solid #e5e7eb;
                                font-size: 14px;
                                color: #6b7280;
                                text-align: center;
                            }
                            .order-details {
                                background: #f8fafc;
                                padding: 20px;
                                border-radius: 8px;
                                margin: 20px 0;
                                border-left: 4px solid #3b82f6;
                            }
                            .order-table {
                                width: 100%;
                                border-collapse: collapse;
                                margin-top: 15px;
                            }
                            .order-table th, .order-table td {
                                padding: 8px 12px;
                                text-align: left;
                                border-bottom: 1px solid #e5e7eb;
                            }
                            .order-table th {
                                background: #f1f5f9;
                                font-weight: 600;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="email-container">
                            <div class="header">
                                <div class="logo">📦 Shopuda</div>
                                <div>온라인 쇼핑몰 통합 관리 시스템</div>
                            </div>
                            
                            <h2>${this.emailSubject}</h2>
                            
                            <div class="content">${this.emailContent}</div>
                            
                            ${orderDetails}
                            
                            <div class="footer">
                                <p>본 메일은 Shopuda ERP 시스템에서 자동 발송되었습니다.</p>
                                <p>
                                    📞 문의: 02-1234-5678 | 
                                    📧 이메일: support@shopuda.com
                                </p>
                                <p style="margin-top: 15px; font-size: 12px; color: #9ca3af;">
                                    © 2024 Shopuda. All rights reserved.
                                </p>
                            </div>
                        </div>
                    </body>
                </html>
            `);
            previewWindow.document.close();
        },
        
        generateOrderDetailsHtml() {
            return `
            <div class="order-details">
                <h3>📋 주문 상세 정보</h3>
                <p><strong>주문번호:</strong> {{ order.order_number }}</p>
                <p><strong>주문일시:</strong> {{ order.created_at|date:"Y년 m월 d일 H:i" }}</p>
                <p><strong>주문상태:</strong> {{ order.get_status_display }}</p>
                
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>상품명</th>
                            <th>수량</th>
                            <th>단가</th>
                            <th>합계</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items.all %}
                        <tr>
                            <td>{{ item.product.name }}</td>
                            <td>{{ item.quantity }}개</td>
                            <td>₩{{ item.unit_price|floatformat:0|intcomma }}</td>
                            <td>₩{{ item.total_price|floatformat:0|intcomma }}</td>
                        </tr>
                        {% endfor %}
                        <tr style="background: #f1f5f9; font-weight: bold;">
                            <td colspan="3">총 주문 금액:</td>
                            <td>₩{{ order.total_amount|floatformat:0|intcomma }}</td>
                        </tr>
                    </tbody>
                </table>
                
                {% if order.shipping_address %}
                <p style="margin-top: 15px;"><strong>🚚 배송지:</strong> {{ order.shipping_address }}</p>
                {% endif %}
                {% if order.tracking_number %}
                <p><strong>📦 운송장 번호:</strong> {{ order.tracking_number }}</p>
                {% endif %}
            </div>
            `;
        },
        
        updateStatus() {
            this.showStatusModal = true;
        },
        
        async confirmStatusUpdate() {
            try {
                this.showLoading('상태를 변경하는 중...');
                
                const response = await fetch(`{% url 'orders:status_update' order.pk %}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken(),
                    },
                    body: JSON.stringify({
                        status: this.newStatus.toLowerCase(),
                        tracking_number: this.trackingNumber
                    })
                });
                
                const data = await response.json();
                this.hideLoading();
                
                if (data.success) {
                    this.showAlert('success', '변경 완료', data.message);
                    this.showStatusModal = false;
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    this.showAlert('error', '변경 실패', data.message || '상태 변경에 실패했습니다.');
                }
            } catch (error) {
                this.hideLoading();
                this.showAlert('error', '네트워크 오류', '상태 변경 중 오류가 발생했습니다.');
                console.error('Status update error:', error);
            }
        },
        
        printOrder() {
            // 인쇄 날짜 설정
            document.getElementById('print-date').textContent = new Date().toLocaleString('ko-KR');
            
            // 인쇄용 스타일 적용
            const printArea = document.querySelector('.print-area');
            printArea.style.display = 'block';
            
            // 브라우저 인쇄 대화상자 열기
            setTimeout(() => {
                window.print();
                // 인쇄 후 다시 숨김
                setTimeout(() => {
                    printArea.style.display = 'none';
                }, 1000);
            }, 100);
        },
        
        trackPackage() {
            if ('{{ order.tracking_number }}') {
                // 실제 택배사 추적 페이지로 이동 (CJ대한통운 예시)
                const trackingUrl = `https://www.doortodoor.co.kr/parcel/doortodoor.do?fsp_action=PARC_ACT_002&fsp_cmd=retrieveInvNoACT&invc_no={{ order.tracking_number }}`;
                window.open(trackingUrl, '_blank');
            } else {
                this.showAlert('warning', '추적 불가', '운송장 번호가 없습니다.');
            }
        },
        
        async cancelOrder() {
            const result = await this.showConfirm(
                '주문 취소', 
                '주문을 취소하시겠습니까?\n이 작업은 되돌릴 수 없습니다.',
                'warning'
            );
            
            if (result.isConfirmed) {
                try {
                    this.showLoading('주문을 취소하는 중...');
                    
                    const response = await fetch(`{% url 'orders:status_update' order.pk %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken(),
                        },
                        body: JSON.stringify({
                            status: 'cancelled'
                        })
                    });
                    
                    const data = await response.json();
                    this.hideLoading();
                    
                    if (data.success) {
                        this.showAlert('success', '취소 완료', '주문이 취소되었습니다.');
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        this.showAlert('error', '취소 실패', data.message || '주문 취소에 실패했습니다.');
                    }
                } catch (error) {
                    this.hideLoading();
                    this.showAlert('error', '네트워크 오류', '주문 취소 중 오류가 발생했습니다.');
                    console.error('Cancel order error:', error);
                }
            }
        },
        
        // 유틸리티 함수들
        getCsrfToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]');
            if (token) {
                return token.value;
            }
            
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return decodeURIComponent(value);
                }
            }
            
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            
            return '';
        },
        
        showLoading(message = '처리 중...') {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: message,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
            }
        },
        
        hideLoading() {
            if (typeof Swal !== 'undefined') {
                Swal.close();
            }
        },
        
        showAlert(icon, title, message) {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: icon,
                    title: title,
                    text: message,
                    confirmButtonColor: icon === 'success' ? '#059669' : icon === 'error' ? '#dc2626' : '#d97706',
                    timer: icon === 'success' ? 3000 : undefined,
                    timerProgressBar: icon === 'success',
                    showConfirmButton: icon !== 'success'
                });
            } else {
                alert(`${title}: ${message}`);
            }
        },
        
        showConfirm(title, text, icon = 'question') {
            if (typeof Swal !== 'undefined') {
                return Swal.fire({
                    title: title,
                    text: text,
                    icon: icon,
                    showCancelButton: true,
                    confirmButtonColor: icon === 'warning' ? '#ef4444' : '#3b82f6',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: '확인',
                    cancelButtonText: '취소',
                    reverseButtons: true
                });
            } else {
                return { isConfirmed: confirm(`${title}\n${text}`) };
            }
        }
    }
}

// 페이지 로드 시 애니메이션
document.addEventListener('DOMContentLoaded', function() {
    // 카드들에 순차적으로 애니메이션 적용
    const cards = document.querySelectorAll('.bg-white, .dark\\:bg-gray-800');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('animate-fade-in');
    });
    
    // 테이블 행들에 애니메이션 적용
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach((row, index) => {
        row.style.animationDelay = `${0.5 + index * 0.05}s`;
        row.classList.add('animate-fade-in');
    });
});

// 키보드 단축키
document.addEventListener('keydown', function(e) {
    // ESC: 모달 닫기
    if (e.key === 'Escape') {
        const orderDetailComponent = document.querySelector('[x-data*="orderDetail"]');
        if (orderDetailComponent && orderDetailComponent._x_dataStack) {
            const data = orderDetailComponent._x_dataStack[0];
            if (data.showStatusModal) {
                data.showStatusModal = false;
            }
            if (data.showEmailModal) {
                data.showEmailModal = false;
            }
        }
    }
    
    // Ctrl/Cmd + P: 인쇄
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        const orderDetailComponent = document.querySelector('[x-data*="orderDetail"]');
        if (orderDetailComponent && orderDetailComponent._x_dataStack) {
            orderDetailComponent._x_dataStack[0].printOrder();
        }
    }
    
    // Ctrl/Cmd + E: 이메일 모달
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
        e.preventDefault();
        const orderDetailComponent = document.querySelector('[x-data*="orderDetail"]');
        if (orderDetailComponent && orderDetailComponent._x_dataStack) {
            const data = orderDetailComponent._x_dataStack[0];
            if (data.hasCustomerEmail) {
                data.showEmailModal = true;
            }
        }
    }
});

// 인쇄 완료 후 이벤트
window.addEventListener('afterprint', function() {
    const printArea = document.querySelector('.print-area');
    if (printArea) {
        printArea.style.display = 'none';
    }
});
</script>
{% endblock %}