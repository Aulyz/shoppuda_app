{% extends 'base.html' %}
{% load static humanize %}

{% block title %}재고 조정 - Shopuda ERP{% endblock %}

{% block extra_css %}
<style>
    .stock-badge {
        transition: all 0.3s ease;
    }
    .stock-badge:hover {
        transform: scale(1.05);
    }
    .product-row {
        transition: all 0.2s ease;
    }
    .product-row:hover {
        background-color: rgba(16, 185, 129, 0.05);
    }
    .dark .product-row:hover {
        background-color: rgba(16, 185, 129, 0.1);
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    .pulse-animation {
        animation: pulse 2s infinite;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="flex items-center space-x-2">
    <i class="fas fa-home text-gray-400"></i>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <a href="{% url 'inventory:overview' %}" class="text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors">재고 관리</a>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <span class="text-gray-900 dark:text-white font-medium">재고 조정</span>
</div>
{% endblock %}

{% block content %}
<div x-data="stockAdjustmentApp()" x-init="init()">
    <!-- 헤더 섹션 -->
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden mb-6">
        <div class="bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-700 px-6 py-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                        <i class="fas fa-sliders-h text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-white">재고 조정</h1>
                        <p class="text-emerald-100 font-medium">상품의 재고 수량을 정확하게 관리하세요</p>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3">
                    <button type="button" 
                            @click="showBulkModal = true"
                            :disabled="selectedProducts.length === 0"
                            class="inline-flex items-center px-4 py-2 backdrop-blur-sm border border-white/30 rounded-lg text-white font-medium transition-all duration-200 hover:scale-105 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            :class="selectedProducts.length > 0 ? 'bg-white/20 hover:bg-white/30' : ''">
                        <i class="fas fa-layer-group mr-2"></i>
                        일괄 조정 (<span x-text="selectedProducts.length"></span>개)
                    </button>
                    <button type="button" 
                            @click="exportData()"
                            class="inline-flex items-center px-4 py-2 bg-white/20 backdrop-blur-sm border border-white/30 rounded-lg text-white font-medium hover:bg-white/30 transition-all duration-200 hover:scale-105 hover:shadow-lg">
                        <i class="fas fa-download mr-2"></i>
                        내보내기
                    </button>
                </div>
            </div>
        </div>

        <!-- 통계 카드 -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-6 bg-gray-50 dark:bg-gray-900/50">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">전체 상품</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white mt-1">{{ total_products|intcomma }}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-box text-blue-600 dark:text-blue-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">재고 부족</p>
                        <p class="text-2xl font-bold text-orange-600 dark:text-orange-400 mt-1">{{ low_stock_count|intcomma }}</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-orange-600 dark:text-orange-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">품절 상품</p>
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400 mt-1">{{ out_of_stock_count|intcomma }}</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-times-circle text-red-600 dark:text-red-400"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">과재고 상품</p>
                        <p class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-1">{{ overstock_count|intcomma }}</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-archive text-purple-600 dark:text-purple-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 필터 섹션 -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
        <form method="get" action="{% url 'inventory:adjustment' %}" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- 검색 -->
                <div class="relative">
                    <input type="text" 
                           name="search" 
                           value="{{ search_query }}"
                           placeholder="상품명, SKU 검색..."
                           class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100 placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                    </div>
                </div>

                <!-- 카테고리 필터 -->
                <select name="category" 
                        class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200">
                    <option value="">모든 카테고리</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>

                <!-- 재고 상태 필터 -->
                <select name="stock_status" 
                        class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-colors duration-200">
                    <option value="">모든 상태</option>
                    <option value="low" {% if selected_stock_status == "low" %}selected{% endif %}>재고 부족</option>
                    <option value="out" {% if selected_stock_status == "out" %}selected{% endif %}>품절</option>
                    <option value="normal" {% if selected_stock_status == "normal" %}selected{% endif %}>정상</option>
                    <option value="over" {% if selected_stock_status == "over" %}selected{% endif %}>과재고</option>
                </select>

                <!-- 필터 버튼 -->
                <div class="flex gap-2">
                    <button type="submit" 
                            class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-200 hover:shadow-lg">
                        <i class="fas fa-filter mr-2"></i>필터 적용
                    </button>
                    {% if has_search %}
                    <a href="{% url 'inventory:adjustment' %}" 
                       class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors duration-200">
                        <i class="fas fa-times"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>

    <!-- 상품 목록 테이블 -->
    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                    <tr>
                        <th class="px-6 py-3 text-left">
                            <input type="checkbox" 
                                   x-model="selectAll"
                                   @change="toggleSelectAll()"
                                   class="w-4 h-4 text-emerald-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            상품 정보
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            현재 재고
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            재고 상태
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            최소/최대
                        </th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                            조정
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% for product in products %}
                    <tr class="product-row hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" 
                                   :value="{{ product.id }}"
                                   x-model="selectedProducts"
                                   class="w-4 h-4 text-emerald-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-emerald-500">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    {% if product.images.exists %}
                                        <img class="h-10 w-10 rounded-lg object-cover" 
                                             src="{{ product.images.first.image.url }}" 
                                             alt="{{ product.name }}">
                                    {% else %}
                                        <div class="h-10 w-10 rounded-lg bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                            <i class="fas fa-box text-gray-400 dark:text-gray-500"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                                        {{ product.name }}
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        SKU: {{ product.sku }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="text-lg font-semibold text-gray-900 dark:text-white" id="stock-{{ product.id }}">
                                {{ product.stock_quantity|intcomma }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            {% if product.stock_quantity == 0 %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 stock-badge">
                                    <i class="fas fa-times-circle mr-1"></i> 품절
                                </span>
                            {% elif product.stock_quantity <= product.min_stock_level %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 stock-badge">
                                    <i class="fas fa-exclamation-triangle mr-1"></i> 부족
                                </span>
                            {% elif product.stock_quantity >= product.max_stock_level %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-300 stock-badge">
                                    <i class="fas fa-archive mr-1"></i> 과재고
                                </span>
                            {% else %}
                                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 stock-badge">
                                    <i class="fas fa-check-circle mr-1"></i> 정상
                                </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400">
                            <div class="flex flex-col">
                                <span>최소: {{ product.min_stock_level|intcomma }}</span>
                                <span>최대: {{ product.max_stock_level|intcomma }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button type="button" 
                                    @click="openAdjustmentModal('{{ product.id }}', '{{ product.name|escapejs }}', {{ product.stock_quantity }})"
                                    class="inline-flex items-center px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-medium rounded-lg transition-all duration-200 hover:shadow-lg hover:scale-105">
                                <i class="fas fa-edit mr-1.5"></i>
                                조정
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-box-open text-gray-400 dark:text-gray-600 text-5xl mb-4"></i>
                                <p class="text-gray-500 dark:text-gray-400">조건에 맞는 상품이 없습니다.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        {% if products.has_other_pages %}
        <div class="bg-gray-50 dark:bg-gray-900/50 px-6 py-4 border-t border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    전체 <span class="font-semibold">{{ products.paginator.count }}</span>개 중 
                    <span class="font-semibold">{{ products.start_index }}-{{ products.end_index }}</span>
                </div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                    {% if products.has_previous %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.previous_page_number }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    {% endif %}
                    
                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-300">
                        {{ products.number }} / {{ products.paginator.num_pages }}
                    </span>
                    
                    {% if products.has_next %}
                        <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ products.next_page_number }}" 
                           class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    {% endif %}
                </nav>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- 개별 조정 모달 -->
    <div x-show="showModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" 
                 @click="closeModal()"></div>

            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-2xl px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-sliders-h text-emerald-600 dark:text-emerald-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            재고 조정
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-400" x-text="currentProductName"></p>
                        </div>
                        
                        <div class="mt-4 space-y-4">
                            <!-- 조정 방식 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    조정 방식
                                </label>
                                <select x-model="adjustmentType" 
                                        @change="updatePreview()"
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                                    <option value="set">설정 (지정한 값으로 변경)</option>
                                    <option value="add">추가 (현재 값에 더하기)</option>
                                    <option value="subtract">차감 (현재 값에서 빼기)</option>
                                </select>
                            </div>
                            
                            <!-- 수량 입력 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <span x-show="adjustmentType === 'set'">새로운 재고 수량</span>
                                    <span x-show="adjustmentType === 'add'">추가할 수량</span>
                                    <span x-show="adjustmentType === 'subtract'">차감할 수량</span>
                                </label>
                                <input type="number" 
                                       x-model="adjustmentValue" 
                                       @input="updatePreview()"
                                       min="0"
                                       placeholder="수량 입력"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                            </div>
                            
                            <!-- 미리보기 -->
                            <div x-show="adjustmentType !== 'set'" 
                                 class="p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                <p class="text-sm text-blue-700 dark:text-blue-300">
                                    <span class="font-medium">현재 재고:</span> <span x-text="currentStock"></span>개
                                    <br>
                                    <span class="font-medium">조정 후:</span> 
                                    <span x-text="previewStock" class="font-bold"></span>개
                                    <span x-show="previewStock < 0" class="text-red-600 dark:text-red-400 ml-2">
                                        <i class="fas fa-exclamation-triangle"></i> 음수 불가
                                    </span>
                                </p>
                            </div>
                            
                            <!-- 조정 사유 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    조정 사유 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       x-model="adjustmentReason" 
                                       placeholder="예: 재고 실사, 파손, 반품 등"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" 
                            @click="applyAdjustment()"
                            :disabled="!canApplyAdjustment()"
                            class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                        <i class="fas fa-check mr-2"></i>
                        적용
                    </button>
                    <button type="button" 
                            @click="closeModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:mt-0 sm:w-auto sm:text-sm transition-all duration-200">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 일괄 조정 모달 -->
    <div x-show="showBulkModal" x-cloak 
         class="fixed inset-0 z-50 overflow-y-auto"
         x-transition:enter="ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed bg-gray-500 dark:bg-gray-900 bg-opacity-75 dark:bg-opacity-75 transition-opacity" 
                 @click="closeBulkModal()"></div>

            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-2xl px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full sm:p-6"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
                
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-emerald-100 dark:bg-emerald-900/30 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-layer-group text-emerald-600 dark:text-emerald-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            일괄 재고 조정
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                선택한 <span x-text="selectedProducts.length"></span>개 상품의 재고를 일괄 조정합니다.
                            </p>
                        </div>
                        
                        <div class="mt-4 space-y-4">
                            <!-- 조정 방식 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    조정 방식
                                </label>
                                <select x-model="bulkAdjustmentType" 
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                                    <option value="add">추가 (현재 값에 더하기)</option>
                                    <option value="subtract">차감 (현재 값에서 빼기)</option>
                                    <option value="percentage">퍼센트 조정</option>
                                </select>
                            </div>
                            
                            <!-- 수량/퍼센트 입력 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <span x-show="bulkAdjustmentType !== 'percentage'">조정할 수량</span>
                                    <span x-show="bulkAdjustmentType === 'percentage'">조정 퍼센트 (%)</span>
                                </label>
                                <input type="number" 
                                       x-model="bulkAdjustmentValue" 
                                       :min="bulkAdjustmentType === 'percentage' ? '-100' : '0'"
                                       :step="bulkAdjustmentType === 'percentage' ? '0.1' : '1'"
                                       placeholder="값 입력"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                            </div>
                            
                            <!-- 조정 사유 -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    조정 사유 <span class="text-red-500">*</span>
                                </label>
                                <input type="text" 
                                       x-model="bulkAdjustmentReason" 
                                       placeholder="예: 재고 실사, 계절 할인 등"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-white transition-colors duration-200">
                            </div>
                            
                            <!-- 경고 메시지 -->
                            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800">
                                <p class="text-sm text-yellow-700 dark:text-yellow-300">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    일괄 조정은 취소할 수 없습니다. 신중하게 확인하세요.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
                    <button type="button" 
                            @click="applyBulkAdjustment()"
                            :disabled="!canApplyBulkAdjustment()"
                            class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-emerald-600 text-base font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                        <i class="fas fa-check mr-2"></i>
                        일괄 적용
                    </button>
                    <button type="button" 
                            @click="closeBulkModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-lg border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 sm:mt-0 sm:w-auto sm:text-sm transition-all duration-200">
                        취소
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function stockAdjustmentApp() {
    return {
        // 상태 변수
        selectedProducts: [],
        selectAll: false,
        showModal: false,
        showBulkModal: false,
        
        // 개별 조정 변수
        currentProductId: null,
        currentProductName: '',
        currentStock: 0,
        adjustmentType: 'set',
        adjustmentValue: 0,
        adjustmentReason: '',
        previewStock: 0,
        
        // 일괄 조정 변수
        bulkAdjustmentType: 'add',
        bulkAdjustmentValue: 0,
        bulkAdjustmentReason: '',
        
        // 초기화
        init() {
            // CSRF 토큰 설정
            this.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                            document.querySelector('meta[name="csrf-token"]')?.content;
        },
        
        // 전체 선택/해제
        toggleSelectAll() {
            if (this.selectAll) {
                // 현재 페이지의 모든 상품 ID 수집
                const checkboxes = document.querySelectorAll('input[type="checkbox"][x-model="selectedProducts"]');
                this.selectedProducts = Array.from(checkboxes).map(cb => parseInt(cb.value));
            } else {
                this.selectedProducts = [];
            }
        },
        
        // 개별 조정 모달 열기
        openAdjustmentModal(productId, productName, stock) {
            this.currentProductId = productId;
            this.currentProductName = productName;
            this.currentStock = stock;
            this.adjustmentType = 'set';
            this.adjustmentValue = stock;
            this.adjustmentReason = '';
            this.updatePreview();
            this.showModal = true;
        },
        
        // 모달 닫기
        closeModal() {
            this.showModal = false;
            this.resetModalData();
        },
        
        // 모달 데이터 초기화
        resetModalData() {
            this.currentProductId = null;
            this.currentProductName = '';
            this.currentStock = 0;
            this.adjustmentValue = 0;
            this.adjustmentReason = '';
            this.previewStock = 0;
        },
        
        // 미리보기 업데이트
        updatePreview() {
            const value = parseInt(this.adjustmentValue) || 0;
            
            if (this.adjustmentType === 'set') {
                this.previewStock = value;
            } else if (this.adjustmentType === 'add') {
                this.previewStock = this.currentStock + value;
            } else if (this.adjustmentType === 'subtract') {
                this.previewStock = this.currentStock - value;
            }
        },
        
        // 조정 가능 여부 확인
        canApplyAdjustment() {
            return this.adjustmentReason.trim() !== '' && 
                   this.adjustmentValue !== '' && 
                   this.previewStock >= 0;
        },
        
        // 개별 재고 조정 적용
        async applyAdjustment() {
            if (!this.canApplyAdjustment()) return;
            
            try {
                const data = {
                    product_id: this.currentProductId,
                    adjustment_type: this.adjustmentType,
                    reason: this.adjustmentReason.trim()
                };
                
                if (this.adjustmentType === 'set') {
                    data.new_quantity = parseInt(this.adjustmentValue);
                } else {
                    data.adjustment_value = parseInt(this.adjustmentValue);
                }
                
                const response = await fetch('{% url "inventory:apply_stock_adjustment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // 성공 메시지
                    Swal.fire({
                        icon: 'success',
                        title: '재고 조정 완료',
                        text: result.message,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // UI 업데이트
                    this.updateStockDisplay(this.currentProductId, result.new_quantity);
                    this.closeModal();
                } else {
                    throw new Error(result.error || '재고 조정 실패');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '오류',
                    text: error.message || '재고 조정 중 오류가 발생했습니다.'
                });
            }
        },
        
        // 재고 표시 업데이트
        updateStockDisplay(productId, newQuantity) {
            const stockElement = document.getElementById(`stock-${productId}`);
            if (stockElement) {
                stockElement.textContent = new Intl.NumberFormat('ko-KR').format(newQuantity);
                stockElement.classList.add('pulse-animation');
                setTimeout(() => {
                    stockElement.classList.remove('pulse-animation');
                }, 2000);
            }
        },
        
        // 일괄 조정 모달 열기
        openBulkModal() {
            this.showBulkModal = true;
        },
        
        // 일괄 조정 모달 닫기
        closeBulkModal() {
            this.showBulkModal = false;
            this.bulkAdjustmentType = 'add';
            this.bulkAdjustmentValue = 0;
            this.bulkAdjustmentReason = '';
        },
        
        // 일괄 조정 가능 여부 확인
        canApplyBulkAdjustment() {
            return this.selectedProducts.length > 0 &&
                   this.bulkAdjustmentReason.trim() !== '' &&
                   this.bulkAdjustmentValue !== '';
        },
        
        // 일괄 재고 조정 적용
        async applyBulkAdjustment() {
            if (!this.canApplyBulkAdjustment()) return;
            
            const confirmResult = await Swal.fire({
                title: '일괄 재고 조정',
                html: `선택한 <b>${this.selectedProducts.length}개</b> 상품의 재고를 조정하시겠습니까?<br>이 작업은 취소할 수 없습니다.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '조정',
                cancelButtonText: '취소'
            });
            
            if (!confirmResult.isConfirmed) return;
            
            try {
                const response = await fetch('{% url "inventory:apply_bulk_stock_adjustment" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken
                    },
                    body: JSON.stringify({
                        product_ids: this.selectedProducts,
                        adjustment_type: this.bulkAdjustmentType,
                        adjustment_value: parseFloat(this.bulkAdjustmentValue),
                        reason: this.bulkAdjustmentReason.trim()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '일괄 조정 완료',
                        text: `${result.updated_count}개 상품의 재고가 조정되었습니다.`,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        // 페이지 새로고침
                        window.location.reload();
                    });
                    
                    this.closeBulkModal();
                    this.selectedProducts = [];
                    this.selectAll = false;
                } else {
                    throw new Error(result.error || '일괄 조정 실패');
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: '오류',
                    text: error.message || '일괄 조정 중 오류가 발생했습니다.'
                });
            }
        },
        
        // 데이터 내보내기
        exportData() {
            const params = new URLSearchParams(window.location.search);
            params.append('export', 'csv');
            window.location.href = `{% url "inventory:export_stock_data" %}?${params.toString()}`;
        }
    };
}
</script>
{% endblock %}