{% extends 'base.html' %}
{% load humanize %}
{% comment %} templates/reports/dashboard.html - Î≥¥Í≥†ÏÑú ÎåÄÏãúÎ≥¥Îìú {% endcomment %}

{% block title %}Î≥¥Í≥†ÏÑú ÎåÄÏãúÎ≥¥Îìú - Shopuda ERP{% endblock %}

{% block breadcrumb %}
<div class="flex items-center space-x-2">
    <i class="fas fa-home w-4 h-4"></i>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <span>Î≥¥Í≥†ÏÑú</span>
</div>
{% endblock %}

{% block content %}
<div class="space-y-8" x-data="reportsData()">
    <!-- ÌéòÏù¥ÏßÄ Ìó§Îçî -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-xl text-white p-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-2">üìä Î≥¥Í≥†ÏÑú ÎåÄÏãúÎ≥¥Îìú</h1>
                <p class="text-blue-100">ÎπÑÏ¶àÎãàÏä§ ÏÑ±Í≥ºÎ•º ÌïúÎààÏóê ÌôïÏù∏ÌïòÏÑ∏Ïöî</p>
            </div>
            <div class="text-right">
                <div class="text-sm text-blue-100 mb-1">ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏</div>
                <div class="text-lg font-semibold">{{ current_time|date:"Y-m-d H:i" }}</div>
            </div>
        </div>
    </div>

    <!-- Îπ†Î•∏ ÌÜµÍ≥Ñ Ïπ¥Îìú -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Ï¥ù Îß§Ï∂ú -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ï¥ù Îß§Ï∂ú (30Ïùº)</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        ‚Ç©{{ total_revenue|floatformat:0|intcomma }}
                    </p>
                    <p class="text-sm {% if growth_rate >= 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %} mt-1">
                        <i class="fas {% if growth_rate >= 0 %}fa-arrow-up{% else %}fa-arrow-down{% endif %}"></i> 
                        {% if growth_rate >= 0 %}+{% endif %}{{ growth_rate|floatformat:1 }}%
                    </p>
                </div>
                <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-won-sign text-green-600 dark:text-green-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Ï¥ù Ï£ºÎ¨∏ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ï¥ù Ï£ºÎ¨∏ (30Ïùº)</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ total_orders|intcomma }}
                    </p>
                    <p class="text-sm text-blue-600 dark:text-blue-400 mt-1">
                        <i class="fas fa-shopping-cart"></i> ÌèâÍ∑† {{ avg_order_value|floatformat:0|intcomma }}Ïõê
                    </p>
                </div>
                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-blue-600 dark:text-blue-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Ïû¨Í≥† ÌòÑÌô© -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ï¥ù ÏÉÅÌíà</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ total_products|intcomma }}
                    </p>
                    <p class="text-sm text-orange-600 dark:text-orange-400 mt-1">
                        <i class="fas fa-exclamation-triangle"></i> {{ low_stock_count }}Í∞ú Î∂ÄÏ°±
                    </p>
                </div>
                <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-boxes text-orange-600 dark:text-orange-400 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- ÌîåÎû´Ìèº Ïó∞Îèô -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Ïó∞Îèô ÌîåÎû´Ìèº</p>
                    <p class="text-3xl font-bold text-gray-900 dark:text-white">
                        {{ connected_platforms|intcomma }}
                    </p>
                    <p class="text-sm text-purple-600 dark:text-purple-400 mt-1">
                        <i class="fas fa-sync"></i> Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
                    </p>
                </div>
                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                    <i class="fas fa-link text-purple-600 dark:text-purple-400 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Î≥¥Í≥†ÏÑú Îπ†Î•∏ Ïï°ÏÑ∏Ïä§ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Î≥¥Í≥†ÏÑú ÎßÅÌÅ¨ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-file-alt text-indigo-500 mr-2"></i>
                    Îπ†Î•∏ Î≥¥Í≥†ÏÑú Ïï°ÏÑ∏Ïä§
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-3">
                    <a href="{% url 'reports:inventory' %}" 
                       class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-warehouse text-green-600 dark:text-green-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">Ïû¨Í≥† Î≥¥Í≥†ÏÑú</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Ïû¨Í≥† ÌòÑÌô© Î∞è Î≥ÄÎèô</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300"></i>
                        </div>
                    </a>
                    
                    <a href="{% url 'reports:sales' %}" 
                       class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">Îß§Ï∂ú Î∂ÑÏÑù</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Ïùº/ÏõîÎ≥Ñ Îß§Ï∂ú Ï∂îÏù¥</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300"></i>
                        </div>
                    </a>
                    
                    <a href="{% url 'reports:financial' %}" 
                       class="block p-4 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calculator text-yellow-600 dark:text-yellow-400"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">Ïû¨Î¨¥ Î≥¥Í≥†ÏÑú</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">ÏÜêÏùµ Î∞è ÎπÑÏö© Î∂ÑÏÑù</p>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300"></i>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Ïò§ÎäòÏùò ÏÑ±Í≥º -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    Ïò§ÎäòÏùò ÏÑ±Í≥º
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-shopping-bag text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">Ïò§Îäò Ï£ºÎ¨∏</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ today_orders }}Í±¥</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold text-green-600 dark:text-green-400">
                                ‚Ç©{{ today_revenue|floatformat:0|intcomma }}
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-exchange-alt text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">Ïû¨Í≥† Î≥ÄÎèô</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ today_stock_movements }}Í±¥</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-plus text-white"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 dark:text-white">Ïã†Í∑ú ÏÉÅÌíà (7Ïùº)</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">{{ new_products_week }}Í∞ú</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ï∞®Ìä∏ ÏÑπÏÖò - ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Îß§Ï∂ú Ï∞®Ìä∏ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-chart-area text-blue-500 mr-2"></i>
                    ÏµúÍ∑º 7Ïùº Îß§Ï∂ú Ï∂îÏù¥
                </h3>
                <div class="flex space-x-2">
                    <select class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-1 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="7">7Ïùº</option>
                        <option value="14">14Ïùº</option>
                        <option value="30">30Ïùº</option>
                    </select>
                </div>
            </div>
            <!-- Ï∞®Ìä∏ Ïª®ÌÖåÏù¥ÎÑàÏóê Í≥†Ï†ï ÎÜíÏù¥ ÏÑ§Ï†ï -->
            <div class="relative h-64 w-full">
                <canvas id="salesChart" x-ref="salesChart" class="w-full h-full"></canvas>
            </div>
        </div>

        <!-- ÏÉÅÌíà Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∞®Ìä∏ -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    <i class="fas fa-chart-pie text-purple-500 mr-2"></i>
                    Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌåêÎß§ ÎπÑÏú®
                </h3>
            </div>
            <!-- Ï∞®Ìä∏ Ïª®ÌÖåÏù¥ÎÑàÏóê Í≥†Ï†ï ÎÜíÏù¥ ÏÑ§Ï†ï -->
            <div class="relative h-64 w-full">
                <canvas id="categoryChart" x-ref="categoryChart" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <!-- ÏµúÍ∑º ÌôúÎèô -->
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg">
        <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-clock text-indigo-500 mr-2"></i>
                ÏµúÍ∑º Î≥¥Í≥†ÏÑú ÌôúÎèô
            </h3>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div class="flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-download text-green-600 dark:text-green-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Ïû¨Í≥† Î≥¥Í≥†ÏÑú Îã§Ïö¥Î°úÎìú</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">2ÏãúÍ∞Ñ Ï†Ñ</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-chart-bar text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">ÏõîÍ∞Ñ Îß§Ï∂ú Î≥¥Í≥†ÏÑú ÏÉùÏÑ±</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">1Ïùº Ï†Ñ</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                        <i class="fas fa-envelope text-purple-600 dark:text-purple-400"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">Ï£ºÍ∞Ñ Î≥¥Í≥†ÏÑú Ïù¥Î©îÏùº Î∞úÏÜ°</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">3Ïùº Ï†Ñ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function reportsData() {
    return {
        salesChart: null,
        categoryChart: null,
        
        init() {
            // DOMÏù¥ ÏôÑÏ†ÑÌûà Ï§ÄÎπÑÎêú ÌõÑ Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
            this.$nextTick(() => {
                // Ï¢Ä Îçî Í∏¥ ÏßÄÏó∞ÏãúÍ∞ÑÏúºÎ°ú ÏïàÏ†ïÏ†ÅÏù∏ Ï¥àÍ∏∞Ìôî Î≥¥Ïû•
                setTimeout(() => {
                    this.initCharts();
                }, 500);
            });
        },
        
        initCharts() {
            // Í∏∞Ï°¥ Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§Í∞Ä ÏûàÎã§Î©¥ Ï†úÍ±∞
            this.destroyCharts();
            
            try {
                // Îß§Ï∂ú Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
                const salesCanvas = this.$refs.salesChart;
                if (salesCanvas && typeof Chart !== 'undefined') {
                    const salesCtx = salesCanvas.getContext('2d');
                    
                    this.salesChart = new Chart(salesCtx, {
                        type: 'line',
                        data: {
                            labels: ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'],
                            datasets: [{
                                label: 'Îß§Ï∂ú',
                                data: [120000, 150000, 180000, 140000, 200000, 250000, 300000],
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Ï§ëÏöî: Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Ïóê ÎßûÏ∂§
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '‚Ç©' + value.toLocaleString();
                                        }
                                    }
                                }
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        }
                    });
                }

                // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî
                const categoryCanvas = this.$refs.categoryChart;
                if (categoryCanvas && typeof Chart !== 'undefined') {
                    const categoryCtx = categoryCanvas.getContext('2d');
                    
                    this.categoryChart = new Chart(categoryCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Ï†ÑÏûêÏ†úÌíà', 'ÏùòÎ•ò', 'ÏÉùÌôúÏö©Ìíà', 'Ïä§Ìè¨Ï∏†', 'ÎèÑÏÑú'],
                            datasets: [{
                                data: [30, 25, 20, 15, 10],
                                backgroundColor: [
                                    '#3B82F6', '#10B981', '#F59E0B', 
                                    '#EF4444', '#8B5CF6'
                                ],
                                borderWidth: 2,
                                borderColor: '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, // Ï§ëÏöî: Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞Ïóê ÎßûÏ∂§
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
            }
        },
        
        destroyCharts() {
            // Í∏∞Ï°¥ Ï∞®Ìä∏ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ïÎ¶¨
            if (this.salesChart) {
                this.salesChart.destroy();
                this.salesChart = null;
            }
            if (this.categoryChart) {
                this.categoryChart.destroy();
                this.categoryChart = null;
            }
        }
    }
}

// ÌéòÏù¥ÏßÄÍ∞Ä Ïñ∏Î°úÎìúÎê† Îïå Ï∞®Ìä∏ Ï†ïÎ¶¨
window.addEventListener('beforeunload', function() {
    if (window.reportsDataInstance) {
        window.reportsDataInstance.destroyCharts();
    }
});
</script>

<style>
/* Ï∞®Ìä∏ Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÉÄÏùº ÏµúÏ†ÅÌôî */
.chart-container {
    position: relative;
    height: 16rem; /* h-64ÏôÄ ÎèôÏùº */
    width: 100%;
}

/* Ï∞®Ìä∏ Ï∫îÎ≤ÑÏä§ Ïä§ÌÉÄÏùº */
canvas {
    display: block;
    box-sizing: border-box;
}

/* Î∞òÏùëÌòï Ï∞®Ìä∏ Ïä§ÌÉÄÏùº */
@media (max-width: 768px) {
    .chart-container {
        height: 12rem; /* Î™®Î∞îÏùºÏóêÏÑúÎäî Ï¢Ä Îçî ÏûëÍ≤å */
    }
}

/* Ï∞®Ìä∏ Î°úÎî© ÏÉÅÌÉú Ïä§ÌÉÄÏùº */
.chart-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 16rem;
    background-color: #f9fafb;
    border-radius: 0.5rem;
    color: #6b7280;
}

.dark .chart-loading {
    background-color: #374151;
    color: #9ca3af;
}
</style>
{% endblock %}