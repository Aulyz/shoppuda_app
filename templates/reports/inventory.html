{% extends 'base.html' %}
{% load humanize %}
{% load inventory_extras %}
{% comment %} templates/reports/inventory.html - 재고 리포트 페이지 {% endcomment %}

{% block title %}재고 리포트 - Shopuda ERP{% endblock %}

{% block breadcrumb %}
<div class="flex items-center space-x-2">
    <i class="fas fa-home w-4 h-4"></i>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <a href="{% url 'dashboard:home' %}" class="hover:text-gray-600 dark:hover:text-gray-300 transition-colors duration-200">대시보드</a>
    <span class="text-gray-400 dark:text-gray-500">/</span>
    <span>재고 리포트</span>
</div>
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
<style>
/* 애니메이션 효과 */
.fade-in {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-in-left {
    animation: slideInLeft 0.5s ease-out;
}

@keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-30px); }
    to { opacity: 1; transform: translateX(0); }
}

.slide-in-right {
    animation: slideInRight 0.5s ease-out;
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(30px); }
    to { opacity: 1; transform: translateX(0); }
}

/* 카드 호버 효과 */
.report-card {
    transition: all 0.3s ease;
}

.report-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.dark .report-card:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
}

/* 스탯 카드 그라디언트 */
.stat-card-1 {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-card-2 {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card-3 {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card-4 {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

/* 테이블 스트라이프 */
.table-striped tbody tr:nth-child(even) {
    background-color: rgba(249, 250, 251, 0.5);
}

.dark .table-striped tbody tr:nth-child(even) {
    background-color: rgba(31, 41, 55, 0.5);
}

.table-striped tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.05);
}

.dark .table-striped tbody tr:hover {
    background-color: rgba(59, 130, 246, 0.1);
}

/* 프로그레스 바 */
.progress-bar {
    transition: width 1s ease-in-out;
}

/* 로딩 스피너 */
.loading-spinner {
    border: 3px solid #f3f4f6;
    border-top: 3px solid #3b82f6;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 차트 컨테이너 */
.chart-container {
    position: relative;
    height: 300px;
}

/* 반응형 차트 */
@media (max-width: 768px) {
    .chart-container {
        height: 250px;
    }
}

/* 필터 드롭다운 */
.filter-dropdown {
    max-height: 300px;
    overflow-y: auto;
}

/* 상태 표시기 */
.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-normal { background-color: #10b981; }
.status-low { background-color: #f59e0b; }
.status-out { background-color: #ef4444; }
.status-excess { background-color: #8b5cf6; }

/* 프린트 스타일 */
@media print {
    .no-print {
        display: none !important;
    }
    
    .print-break {
        page-break-before: always;
    }
    
    body {
        font-size: 12px;
    }
    
    .report-card {
        box-shadow: none;
        border: 1px solid #ddd;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="space-y-8" x-data="inventoryReport()" x-init="initializeReport()">
    <!-- 페이지 헤더 -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl shadow-2xl overflow-hidden fade-in">
        <div class="px-6 py-8 sm:px-8 lg:px-12">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                        <i class="fas fa-chart-bar text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl lg:text-4xl font-bold text-white">
                            재고 리포트 📊
                        </h1>
                        <p class="text-blue-100 text-lg mt-2">
                            실시간 재고 현황 및 분석 데이터
                        </p>
                    </div>
                </div>
                <div class="mt-6 lg:mt-0 flex flex-col sm:flex-row gap-3">
                    <button @click="exportReport('excel')" 
                            class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all duration-200 backdrop-blur-sm">
                        <i class="fas fa-file-excel mr-2"></i>
                        Excel 내보내기
                    </button>
                    <button @click="exportReport('pdf')" 
                            class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all duration-200 backdrop-blur-sm">
                        <i class="fas fa-file-pdf mr-2"></i>
                        PDF 내보내기
                    </button>
                    <button @click="window.print()" 
                            class="inline-flex items-center px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-medium rounded-xl transition-all duration-200 backdrop-blur-sm no-print">
                        <i class="fas fa-print mr-2"></i>
                        인쇄
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 필터 섹션 -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6 slide-in-left no-print">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div class="flex items-center space-x-2">
                <i class="fas fa-filter text-gray-400 dark:text-gray-500"></i>
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">필터 및 정렬</h3>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <!-- 기간 선택 -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">기간:</label>
                    <input type="date" 
                           x-model="filters.startDate"
                           @change="applyFilters()"
                           class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <span class="text-gray-400">~</span>
                    <input type="date" 
                           x-model="filters.endDate"
                           @change="applyFilters()"
                           class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                </div>
                
                <!-- 카테고리 필터 -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">카테고리:</label>
                    <select x-model="filters.category" 
                            @change="applyFilters()"
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">전체</option>
                        <template x-for="category in categories" :key="category.id">
                            <option :value="category.id" x-text="category.name"></option>
                        </template>
                    </select>
                </div>
                
                <!-- 재고 상태 필터 -->
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300 whitespace-nowrap">상태:</label>
                    <select x-model="filters.stockStatus" 
                            @change="applyFilters()"
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="">전체</option>
                        <option value="normal">정상</option>
                        <option value="low">부족</option>
                        <option value="out">품절</option>
                        <option value="excess">과재고</option>
                    </select>
                </div>
                
                <!-- 새로고침 버튼 -->
                <button @click="refreshReport()" 
                        :disabled="loading"
                        class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200 disabled:opacity-50">
                    <div x-show="loading" class="loading-spinner mr-2"></div>
                    <i x-show="!loading" class="fas fa-sync-alt mr-2"></i>
                    새로고침
                </button>
            </div>
        </div>
    </div>

    <!-- 요약 통계 -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 slide-in-right">
        <!-- 총 상품 수 -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-1 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">총 상품 수</p>
                        <p class="text-white text-3xl font-bold" x-text="stats.totalProducts || 0"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-up text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">전월 대비 +5.2%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-boxes text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 총 재고 가치 -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-2 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">총 재고 가치</p>
                        <p class="text-white text-3xl font-bold" x-text="formatCurrency(stats.totalValue || 0)"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-up text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">전월 대비 +12.8%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-won-sign text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 부족 재고 -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-3 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">부족 재고</p>
                        <p class="text-white text-3xl font-bold" x-text="stats.lowStockCount || 0"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-down text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">전월 대비 -3.1%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- 품절 상품 -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="stat-card-4 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-white/80 text-sm font-medium">품절 상품</p>
                        <p class="text-white text-3xl font-bold" x-text="stats.outOfStockCount || 0"></p>
                        <div class="flex items-center mt-2">
                            <i class="fas fa-arrow-down text-white/80 text-sm mr-1"></i>
                            <span class="text-white/80 text-sm">전월 대비 -8.5%</span>
                        </div>
                    </div>
                    <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-times-circle text-white text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 차트 섹션 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- 재고 상태 분포 -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">재고 상태 분포</h3>
                <div class="flex items-center space-x-2">
                    <span class="status-indicator status-normal"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">정상</span>
                    <span class="status-indicator status-low"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">부족</span>
                    <span class="status-indicator status-out"></span>
                    <span class="text-sm text-gray-600 dark:text-gray-400">품절</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="stockStatusChart"></canvas>
            </div>
        </div>

        <!-- 카테고리별 재고 가치 -->
        <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">카테고리별 재고 가치</h3>
                <button @click="toggleChartType('categoryChart')" 
                        class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                    <i class="fas fa-exchange-alt mr-1"></i>
                    차트 변경
                </button>
            </div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>

    <!-- 재고 추이 차트 -->
    <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">재고 변동 추이</h3>
            <div class="flex items-center space-x-2">
                <select x-model="trendPeriod" 
                        @change="updateTrendChart()"
                        class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
                    <option value="7">최근 7일</option>
                    <option value="30">최근 30일</option>
                    <option value="90">최근 90일</option>
                </select>
            </div>
        </div>
        <div class="chart-container" style="height: 400px;">
            <canvas id="trendChart"></canvas>
        </div>
    </div>

    <!-- 상세 재고 테이블 -->
    <div class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">상세 재고 현황</h3>
                <div class="flex items-center space-x-3">
                    <!-- 검색 -->
                    <div class="relative">
                        <input type="text" 
                               x-model="searchQuery"
                               @input="searchProducts()"
                               placeholder="상품 검색..."
                               class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    
                    <!-- 정렬 -->
                    <select x-model="sortBy" 
                            @change="sortProducts()"
                            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                        <option value="name">상품명</option>
                        <option value="stock">재고량</option>
                        <option value="value">재고가치</option>
                        <option value="status">상태</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full table-striped">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            상품정보
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            카테고리
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            현재고
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            안전재고
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            재고가치
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            상태
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            최근 업데이트
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <template x-for="product in filteredProducts" :key="product.id">
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-12 w-12">
                                        <img :src="product.image || '/static/images/no-image.png'" 
                                             :alt="product.name"
                                             class="h-12 w-12 rounded-lg object-cover border border-gray-200 dark:border-gray-600">
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="product.name"></div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400" x-text="product.sku"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300" 
                                      x-text="product.category"></span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="formatNumber(product.current_stock)"></div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">단위</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900 dark:text-white" x-text="formatNumber(product.min_stock)"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900 dark:text-white" x-text="formatCurrency(product.stock_value)"></div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="getStatusClass(product.status)">
                                    <span :class="getStatusIndicatorClass(product.status)" class="w-2 h-2 rounded-full mr-1.5"></span>
                                    <span x-text="getStatusText(product.status)"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <div x-text="formatDate(product.updated_at)"></div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- 페이지네이션 -->
        <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex items-center justify-between">
            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                <span x-text="`총 ${totalProducts}개 상품 중 ${(currentPage - 1) * pageSize + 1}-${Math.min(currentPage * pageSize, totalProducts)}개 표시`"></span>
            </div>
            <div class="flex items-center space-x-2">
                <button @click="prevPage()" 
                        :disabled="currentPage <= 1"
                        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-chevron-left"></i>
                </button>
                
                <div class="flex items-center space-x-1">
                    <template x-for="page in getPageNumbers()" :key="page">
                        <button @click="goToPage(page)" 
                                :class="page === currentPage ? 'bg-blue-600 text-white' : 'bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600'"
                                class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm transition-colors"
                                x-text="page">
                        </button>
                    </template>
                </div>
                
                <button @click="nextPage()" 
                        :disabled="currentPage >= totalPages"
                        class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 재고 경고 알림 -->
    <div x-show="alerts.length > 0" class="report-card bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900 dark:text-white flex items-center">
                <i class="fas fa-bell text-yellow-500 mr-2"></i>
                재고 경고 알림
            </h3>
            <span class="bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300 text-xs font-medium px-2.5 py-0.5 rounded-full" 
                  x-text="`${alerts.length}건`"></span>
        </div>
        
        <div class="space-y-3">
            <template x-for="alert in alerts" :key="alert.id">
                <div class="flex items-center justify-between p-4 border border-red-200 dark:border-red-800 rounded-lg bg-red-50 dark:bg-red-900/20">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                        </div>
                        <div>
                            <p class="text-sm font-medium text-red-800 dark:text-red-300" x-text="alert.title"></p>
                            <p class="text-sm text-red-600 dark:text-red-400" x-text="alert.message"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @click="resolveAlert(alert.id)" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-check text-sm"></i>
                        </button>
                        <button @click="dismissAlert(alert.id)" 
                                class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div x-show="loading" 
         x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 flex flex-col items-center space-y-4 shadow-2xl">
            <div class="loading-spinner"></div>
            <p class="text-lg font-medium text-gray-900 dark:text-white">리포트 데이터를 불러오는 중...</p>
            <p class="text-sm text-gray-500 dark:text-gray-400">잠시만 기다려주세요</p>
        </div>
    </div>
</div>

<script>
function inventoryReport() {
    return {
        // 데이터
        stats: {
            totalProducts: 0,
            totalValue: 0,
            lowStockCount: 0,
            outOfStockCount: 0
        },
        products: [],
        filteredProducts: [],
        categories: [],
        alerts: [],
        
        // 필터
        filters: {
            startDate: '',
            endDate: '',
            category: '',
            stockStatus: ''
        },
        
        // 검색 및 정렬
        searchQuery: '',
        sortBy: 'name',
        sortDirection: 'asc',
        
        // 페이지네이션
        currentPage: 1,
        pageSize: 20,
        totalProducts: 0,
        totalPages: 0,
        
        // 차트
        charts: {},
        trendPeriod: '30',
        
        // 상태
        loading: false,
        
        // 초기화
        async initializeReport() {
            this.loading = true;
            try {
                await this.loadInitialData();
                await this.loadReportData();
                this.initializeCharts();
                this.loadAlerts();
            } catch (error) {
                console.error('리포트 초기화 오류:', error);
                this.showError('리포트 데이터를 불러오는데 실패했습니다.');
            } finally {
                this.loading = false;
            }
        },
        
        // 초기 데이터 로드
        async loadInitialData() {
            // 날짜 범위 설정 (최근 30일)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(endDate.getDate() - 30);
            
            this.filters.startDate = startDate.toISOString().split('T')[0];
            this.filters.endDate = endDate.toISOString().split('T')[0];
            
            // 카테고리 데이터 로드
            this.categories = [
                { id: 1, name: '전자제품' },
                { id: 2, name: '의류' },
                { id: 3, name: '가전제품' },
                { id: 4, name: '화장품' },
                { id: 5, name: '도서' }
            ];
        },
        
        // 리포트 데이터 로드
        async loadReportData() {
            try {
                const params = new URLSearchParams();
                
                // 필터 파라미터 추가
                if (this.filters.startDate) params.append('start_date', this.filters.startDate);
                if (this.filters.endDate) params.append('end_date', this.filters.endDate);
                if (this.filters.category) params.append('category', this.filters.category);
                if (this.filters.stockStatus) params.append('stock_status', this.filters.stockStatus);
                if (this.searchQuery) params.append('search', this.searchQuery);
                
                // 페이지네이션 파라미터
                params.append('page', this.currentPage);
                params.append('page_size', this.pageSize);
                params.append('sort_by', this.sortBy);
                params.append('sort_direction', this.sortDirection);
                
                const response = await fetch(`{% url 'reports:inventory_data' %}?${params.toString()}`, {
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    this.stats = data.stats;
                    this.filteredProducts = data.products;
                    this.categoryAnalysis = data.categoryAnalysis;
                    this.alerts = data.alerts || [];
                    
                    // 페이지네이션 정보 업데이트
                    if (data.pagination) {
                        this.currentPage = data.pagination.currentPage;
                        this.totalPages = data.pagination.totalPages;
                        this.totalProducts = data.pagination.totalItems;
                    }
                    
                    // 차트 데이터 업데이트
                    await this.updateAllCharts();
                } else {
                    throw new Error(data.error || '데이터 로드 실패');
                }
                
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                this.showError('데이터를 불러오는데 실패했습니다: ' + error.message);
                
                // 기본값 설정
                this.stats = {
                    totalProducts: 0,
                    totalValue: 0,
                    lowStockCount: 0,
                    outOfStockCount: 0
                };
                this.filteredProducts = [];
                this.alerts = [];
            }
        },
        
        // 필터 적용
        async applyFilters() {
            this.loading = true;
            await this.loadReportData();
            this.loading = false;
        },
        
        // 상품 검색
        async searchProducts() {
            this.currentPage = 1; // 검색 시 첫 페이지로 이동
            await this.applyFilters();
        },
        
        // 정렬
        async sortProducts() {
            await this.applyFilters();
        },
        
        // 페이지네이션 업데이트
        updatePaginatedProducts(allProducts) {
            const startIndex = (this.currentPage - 1) * this.pageSize;
            const endIndex = startIndex + this.pageSize;
            this.filteredProducts = allProducts.slice(startIndex, endIndex);
        },
        
        // 페이지 이동
        async prevPage() {
            if (this.currentPage > 1) {
                this.currentPage--;
                await this.applyFilters();
            }
        },
        
        async nextPage() {
            if (this.currentPage < this.totalPages) {
                this.currentPage++;
                await this.applyFilters();
            }
        },
        
        async goToPage(page) {
            this.currentPage = page;
            await this.applyFilters();
        },
        
        getPageNumbers() {
            const pages = [];
            const start = Math.max(1, this.currentPage - 2);
            const end = Math.min(this.totalPages, this.currentPage + 2);
            
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }
            
            return pages;
        },
        
        // 차트 초기화
        initializeCharts() {
            this.initStockStatusChart();
            this.initCategoryChart();
            this.initTrendChart();
        },
        
        // 재고 상태 분포 차트
        async initStockStatusChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=stock_status`);
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('stockStatusChart').getContext('2d');
                    this.charts.stockStatus = new Chart(ctx, {
                        type: 'doughnut',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('재고 상태 차트 오류:', error);
            }
        },
        
        // 카테고리별 재고 가치 차트
        async initCategoryChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=category_value`);
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('categoryChart').getContext('2d');
                    this.charts.category = new Chart(ctx, {
                        type: 'bar',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '백만원';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('카테고리 차트 오류:', error);
            }
        },
        
        // 재고 변동 추이 차트
        async initTrendChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=trend&days=${this.trendPeriod}`);
                const result = await response.json();
                
                if (result.success) {
                    const ctx = document.getElementById('trendChart').getContext('2d');
                    this.charts.trend = new Chart(ctx, {
                        type: 'line',
                        data: result.data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: function(value) {
                                            return value + '백만원';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('추이 차트 오류:', error);
            }
        },
        
        // 추이 차트 업데이트
        async updateTrendChart() {
            try {
                const response = await fetch(`{% url 'reports:inventory_chart_data' %}?type=trend&days=${this.trendPeriod}`);
                const result = await response.json();
                
                if (result.success && this.charts.trend) {
                    this.charts.trend.data = result.data;
                    this.charts.trend.update();
                }
            } catch (error) {
                console.error('추이 차트 업데이트 오류:', error);
            }
        },
        
        // 차트 타입 변경
        toggleChartType(chartName) {
            if (chartName === 'categoryChart') {
                const chart = this.charts.category;
                chart.config.type = chart.config.type === 'bar' ? 'pie' : 'bar';
                chart.update();
            }
        },
        
        // 알림 로드
        async loadAlerts() {
            try {
                const response = await fetch(`{% url 'reports:inventory_alerts' %}`);
                const result = await response.json();
                
                if (result.success) {
                    this.alerts = result.alerts;
                }
            } catch (error) {
                console.error('알림 로드 오류:', error);
            }
        },
        
        // 알림 해결
        resolveAlert(alertId) {
            this.alerts = this.alerts.filter(alert => alert.id !== alertId);
            this.showSuccess('알림이 해결되었습니다.');
        },
        
        // 알림 무시
        dismissAlert(alertId) {
            this.alerts = this.alerts.filter(alert => alert.id !== alertId);
        },
        
        // 리포트 새로고침
        async refreshReport() {
            this.loading = true;
            try {
                await this.loadReportData();
                this.updateAllCharts();
                this.showSuccess('리포트가 새로고침되었습니다.');
            } catch (error) {
                console.error('새로고침 오류:', error);
                this.showError('새로고침에 실패했습니다.');
            } finally {
                this.loading = false;
            }
        },
        
        // 모든 차트 업데이트
        updateAllCharts() {
            Object.values(this.charts).forEach(chart => {
                if (chart && typeof chart.update === 'function') {
                    chart.update();
                }
            });
        },
        
        // 리포트 내보내기
        async exportReport(format) {
            this.loading = true;
            try {
                if (format === 'excel') {
                    await this.exportToExcel();
                } else if (format === 'pdf') {
                    await this.exportToPDF();
                }
                this.showSuccess(`${format.toUpperCase()} 파일이 다운로드되었습니다.`);
            } catch (error) {
                console.error('내보내기 오류:', error);
                this.showError('내보내기에 실패했습니다.');
            } finally {
                this.loading = false;
            }
        },
        
        // Excel 내보내기
        async exportToExcel() {
            try {
                // 현재 필터 상태를 포함한 데이터 전송
                const exportData = {
                    filters: this.filters,
                    search: this.searchQuery
                };
                
                const response = await fetch(`{% url 'reports:export_inventory' %}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrf-token]').content,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                });
                
                if (response.ok) {
                    // 파일 다운로드
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `inventory_report_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    throw new Error('내보내기 실패');
                }
            } catch (error) {
                console.error('Excel 내보내기 오류:', error);
                this.showError('Excel 내보내기에 실패했습니다.');
            }
        },
        
        // PDF 내보내기
        async exportToPDF() {
            // 실제 구현에서는 서버로 데이터 전송하여 PDF 파일 생성
            console.log('PDF 내보내기');
        },
        
        // 유틸리티 메서드
        formatNumber(value) {
            return parseInt(value).toLocaleString('ko-KR');
        },
        
        formatCurrency(value) {
            return '₩' + parseInt(value).toLocaleString('ko-KR');
        },
        
        formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        },
        
        getStatusClass(status) {
            const classes = {
                'normal': 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300',
                'low': 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300',
                'out': 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300',
                'excess': 'bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300'
            };
            return classes[status] || classes.normal;
        },
        
        getStatusIndicatorClass(status) {
            const classes = {
                'normal': 'bg-green-500',
                'low': 'bg-yellow-500',
                'out': 'bg-red-500',
                'excess': 'bg-purple-500'
            };
            return classes[status] || classes.normal;
        },
        
        getStatusText(status) {
            const texts = {
                'normal': '정상',
                'low': '부족',
                'out': '품절',
                'excess': '과재고'
            };
            return texts[status] || '정상';
        },
        
        // 알림 메서드
        showSuccess(message) {
            Swal.fire({
                icon: 'success',
                title: '성공',
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        },
        
        showError(message) {
            Swal.fire({
                icon: 'error',
                title: '오류',
                text: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
            });
        }
    }
}
</script>
{% endblock %}