<!-- 채팅 위젯 (페이지 우측 하단) -->
<div id="chat-widget" class="fixed bottom-4 right-4 z-50">
    <!-- 채팅 버튼 -->
    <button id="chat-button" onclick="toggleChatWidget()" 
            class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full p-4 shadow-lg transition-all duration-300 transform hover:scale-110">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z">
            </path>
        </svg>
        <!-- 알림 배지 -->
        <span id="chat-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
            1
        </span>
    </button>
    
    <!-- 채팅 팝업 -->
    <div id="chat-popup" class="hidden absolute bottom-20 right-0 w-96 bg-white dark:bg-gray-800 rounded-lg shadow-2xl">
        <!-- 헤더 -->
        <div class="bg-indigo-600 text-white p-4 rounded-t-lg">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="font-semibold">실시간 상담</h3>
                    <p class="text-sm opacity-90">궁금하신 점을 물어보세요</p>
                </div>
                <button onclick="closeChatWidget()" class="text-white hover:text-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- 채팅 내용 -->
        <div id="chat-content" class="h-96">
            <!-- 초기 화면 -->
            <div id="chat-welcome" class="p-4">
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 dark:bg-indigo-900 rounded-full mb-4">
                        <svg class="w-8 h-8 text-indigo-600 dark:text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z">
                            </path>
                        </svg>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">안녕하세요!</h4>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">무엇을 도와드릴까요?</p>
                    
                    <!-- 로그인 사용자 -->
                    {% if user.is_authenticated %}
                    <button onclick="startChatInWidget()" 
                            class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        채팅 시작하기
                    </button>
                    {% else %}
                    <!-- 비로그인 사용자 -->
                    <div class="space-y-3">
                        <button onclick="showGuestForm()" 
                                class="w-full px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            채팅 시작하기
                        </button>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            또는 <a href="{% url 'accounts:login' %}" class="text-indigo-600 hover:underline">로그인</a>하여 더 나은 서비스를 받으세요
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- 비로그인 사용자 정보 입력 폼 -->
            <div id="guest-form" class="p-4 hidden">
                <form id="chat-guest-form" onsubmit="startGuestChat(event)">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">이름 *</label>
                            <input type="text" name="name" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">이메일</label>
                            <input type="email" name="email" 
                                   class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">상담 주제</label>
                            <select name="subject" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                                <option value="">선택하세요</option>
                                <option value="주문 문의">주문 문의</option>
                                <option value="배송 문의">배송 문의</option>
                                <option value="상품 문의">상품 문의</option>
                                <option value="교환/반품">교환/반품</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            채팅 시작
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- 채팅 화면 -->
            <div id="chat-room" class="hidden flex flex-col h-full">
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- 메시지가 여기에 표시됩니다 -->
                </div>
                <div class="border-t dark:border-gray-700 p-4">
                    <form id="chat-form" onsubmit="sendMessage(event)" class="flex gap-2">
                        <input type="text" id="message-input" placeholder="메시지를 입력하세요..." 
                               class="flex-1 rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white">
                        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            전송
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 운영 시간 안내 -->
        <div class="border-t dark:border-gray-700 px-4 py-3 bg-gray-50 dark:bg-gray-900 rounded-b-lg">
            <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                상담 시간: 평일 09:00 - 18:00
            </p>
        </div>
    </div>
</div>

<style>
#chat-popup {
    animation: slideUp 0.3s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@media (max-width: 640px) {
    #chat-popup {
        width: calc(100vw - 2rem);
        right: -0.5rem;
    }
}
</style>

<script>
function toggleChatWidget() {
    const popup = document.getElementById('chat-popup');
    popup.classList.toggle('hidden');
    
    // 배지 숨기기
    if (!popup.classList.contains('hidden')) {
        document.getElementById('chat-badge').classList.add('hidden');
    }
}

function closeChatWidget() {
    document.getElementById('chat-popup').classList.add('hidden');
}

let chatSocket = null;
let sessionId = null;

function startChatInWidget() {
    // 로그인 사용자는 바로 채팅 시작
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('{% url "chat:start_chat_ajax" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sessionId = data.session_id;
            initializeChat();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function showGuestForm() {
    document.getElementById('chat-welcome').classList.add('hidden');
    document.getElementById('guest-form').classList.remove('hidden');
}

function startGuestChat(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    fetch('{% url "chat:start_chat_ajax" %}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            sessionId = data.session_id;
            initializeChat();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function initializeChat() {
    // UI 전환
    document.getElementById('chat-welcome').classList.add('hidden');
    document.getElementById('guest-form').classList.add('hidden');
    document.getElementById('chat-room').classList.remove('hidden');
    
    // WebSocket 연결
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.hostname + (window.location.port ? ':' + window.location.port : '');
    chatSocket = new WebSocket(
        protocol + '//' + wsHost + '/ws/chat/' + sessionId + '/'
    );
    
    chatSocket.onopen = function(e) {
        console.log('채팅 연결됨');
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'message' && data.data) {
            displayMessage(data.data);
        }
    };
    
    chatSocket.onclose = function(e) {
        console.log('채팅 연결 종료');
    };
}

function sendMessage(event) {
    event.preventDefault();
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (message && chatSocket) {
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInput.value = '';
    }
}

function displayMessage(data) {
    const messagesDiv = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    const isCustomer = data.sender_type === 'customer';
    
    messageDiv.className = `flex ${isCustomer ? 'justify-end' : 'justify-start'}`;
    messageDiv.innerHTML = `
        <div class="max-w-xs px-4 py-2 rounded-lg ${
            isCustomer 
                ? 'bg-indigo-600 text-white' 
                : 'bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white'
        }">
            <p class="text-sm">${data.content || data.message || ''}</p>
            <p class="text-xs mt-1 opacity-70">${new Date(data.created_at || data.timestamp).toLocaleTimeString()}</p>
        </div>
    `;
    
    messagesDiv.appendChild(messageDiv);
    // 자동 스크롤
    setTimeout(() => {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, 100);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 외부 클릭시 닫기
document.addEventListener('click', function(event) {
    const widget = document.getElementById('chat-widget');
    const popup = document.getElementById('chat-popup');
    
    if (!widget.contains(event.target) && !popup.classList.contains('hidden')) {
        closeChatWidget();
    }
});
</script>