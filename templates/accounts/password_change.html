{% extends 'base.html' %}

{% block title %}비밀번호 변경 - Shopuda{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">
    <div class="mb-8">
        <a href="{% url 'accounts:profile' %}" class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 mb-4 inline-block">
            <i class="fas fa-arrow-left mr-2"></i>프로필로 돌아가기
        </a>
        
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">비밀번호 변경</h1>
        <p class="text-gray-600 dark:text-gray-300">계정 보안을 위해 정기적으로 비밀번호를 변경해주세요.</p>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <form method="post" onsubmit="return validatePassword()">
            {% csrf_token %}
            
            <!-- 현재 비밀번호 -->
            <div class="mb-6">
                <label for="current_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    현재 비밀번호
                </label>
                <input type="password" 
                       id="current_password" 
                       name="current_password" 
                       required
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                       placeholder="현재 비밀번호를 입력하세요">
            </div>

            <!-- 새 비밀번호 -->
            <div class="mb-6">
                <label for="new_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    새 비밀번호
                </label>
                <input type="password" 
                       id="new_password" 
                       name="new_password" 
                       required
                       minlength="8"
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                       placeholder="새 비밀번호를 입력하세요 (8자 이상)"
                       onkeyup="checkPasswordStrength()">
                
                <!-- 비밀번호 강도 표시 -->
                <div class="mt-2">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-xs text-gray-500 dark:text-gray-400">비밀번호 강도</span>
                        <span id="strength-text" class="text-xs font-medium"></span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div id="strength-bar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 비밀번호 요구사항 -->
                <ul class="mt-3 text-xs text-gray-600 dark:text-gray-400 space-y-1">
                    <li id="length-check" class="flex items-center">
                        <i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>
                        최소 8자 이상
                    </li>
                    <li id="letter-check" class="flex items-center">
                        <i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>
                        영문 포함
                    </li>
                    <li id="number-check" class="flex items-center">
                        <i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>
                        숫자 포함
                    </li>
                    <li id="special-check" class="flex items-center">
                        <i class="fas fa-circle text-gray-400 mr-2" style="font-size: 6px;"></i>
                        특수문자 포함 (선택)
                    </li>
                </ul>
            </div>

            <!-- 새 비밀번호 확인 -->
            <div class="mb-6">
                <label for="confirm_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    새 비밀번호 확인
                </label>
                <input type="password" 
                       id="confirm_password" 
                       name="confirm_password" 
                       required
                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-700 dark:text-white"
                       placeholder="새 비밀번호를 다시 입력하세요"
                       onkeyup="checkPasswordMatch()">
                <p id="match-message" class="mt-1 text-sm"></p>
            </div>

            <!-- 보안 팁 -->
            <div class="mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-300 mb-2">
                    <i class="fas fa-shield-alt mr-2"></i>보안 팁
                </h4>
                <ul class="text-xs text-blue-700 dark:text-blue-200 space-y-1">
                    <li>• 다른 사이트에서 사용하지 않는 고유한 비밀번호를 사용하세요</li>
                    <li>• 개인정보(이름, 생일 등)가 포함된 비밀번호는 피하세요</li>
                    <li>• 정기적으로 비밀번호를 변경하세요</li>
                </ul>
            </div>

            <!-- 버튼 -->
            <div class="flex justify-end space-x-4">
                <a href="{% url 'accounts:profile' %}" 
                   class="px-6 py-2 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                    취소
                </a>
                <button type="submit" 
                        id="submit-button"
                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <i class="fas fa-lock mr-2"></i>비밀번호 변경
                </button>
            </div>
        </form>
    </div>

    <!-- 추가 보안 옵션 -->
    <div class="mt-6 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">추가 보안 옵션</h3>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h4 class="font-medium text-gray-800 dark:text-white">2단계 인증</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">계정 보안을 강화하려면 2단계 인증을 활성화하세요</p>
                </div>
                <button class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                    설정하기
                </button>
            </div>
            
            <div class="flex items-center justify-between pt-4 border-t dark:border-gray-700">
                <div>
                    <h4 class="font-medium text-gray-800 dark:text-white">로그인 기록</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">최근 로그인 활동을 확인하세요</p>
                </div>
                <button class="text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                    보기
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function checkPasswordStrength() {
    const password = document.getElementById('new_password').value;
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    let strength = 0;
    const checks = {
        length: password.length >= 8,
        letter: /[a-zA-Z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // 체크 표시 업데이트
    updateCheck('length-check', checks.length);
    updateCheck('letter-check', checks.letter);
    updateCheck('number-check', checks.number);
    updateCheck('special-check', checks.special);
    
    // 강도 계산
    Object.values(checks).forEach(passed => {
        if (passed) strength++;
    });
    
    // 강도 표시
    const strengthLevels = [
        { width: '0%', color: '', text: '' },
        { width: '25%', color: 'bg-red-500', text: '약함' },
        { width: '50%', color: 'bg-orange-500', text: '보통' },
        { width: '75%', color: 'bg-yellow-500', text: '강함' },
        { width: '100%', color: 'bg-green-500', text: '매우 강함' }
    ];
    
    const level = strengthLevels[strength];
    strengthBar.style.width = level.width;
    strengthBar.className = `h-2 rounded-full transition-all duration-300 ${level.color}`;
    strengthText.textContent = level.text;
    strengthText.className = `text-xs font-medium ${level.color.replace('bg-', 'text-')}`;
    
    checkFormValidity();
}

function updateCheck(id, passed) {
    const element = document.getElementById(id);
    const icon = element.querySelector('i');
    
    if (passed) {
        icon.className = 'fas fa-check-circle text-green-500 mr-2';
        element.classList.add('text-green-600', 'dark:text-green-400');
        element.classList.remove('text-gray-600', 'dark:text-gray-400');
    } else {
        icon.className = 'fas fa-circle text-gray-400 mr-2';
        element.classList.remove('text-green-600', 'dark:text-green-400');
        element.classList.add('text-gray-600', 'dark:text-gray-400');
    }
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchMessage = document.getElementById('match-message');
    
    if (confirmPassword === '') {
        matchMessage.textContent = '';
        matchMessage.className = 'mt-1 text-sm';
    } else if (newPassword === confirmPassword) {
        matchMessage.textContent = '비밀번호가 일치합니다';
        matchMessage.className = 'mt-1 text-sm text-green-600 dark:text-green-400';
    } else {
        matchMessage.textContent = '비밀번호가 일치하지 않습니다';
        matchMessage.className = 'mt-1 text-sm text-red-600 dark:text-red-400';
    }
    
    checkFormValidity();
}

function checkFormValidity() {
    const currentPassword = document.getElementById('current_password').value;
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const submitButton = document.getElementById('submit-button');
    
    const isValid = 
        currentPassword.length > 0 &&
        newPassword.length >= 8 &&
        /[a-zA-Z]/.test(newPassword) &&
        /[0-9]/.test(newPassword) &&
        newPassword === confirmPassword;
    
    submitButton.disabled = !isValid;
}

function validatePassword() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (newPassword !== confirmPassword) {
        alert('새 비밀번호가 일치하지 않습니다.');
        return false;
    }
    
    return true;
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('current_password').addEventListener('input', checkFormValidity);
});
</script>

{% if messages %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    {% for message in messages %}
        {% if message.tags == 'error' %}
            Swal.fire({
                icon: 'error',
                title: '오류',
                text: '{{ message }}',
            });
        {% elif message.tags == 'success' %}
            Swal.fire({
                icon: 'success',
                title: '성공',
                text: '{{ message }}',
                timer: 3000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = '{% url "accounts:profile" %}';
            });
        {% endif %}
    {% endfor %}
});
</script>
{% endif %}
{% endblock %}